Evans Day Abstract Analysis
========================================================
`r Sys.Date()`
---------------------------------------------

Analyses to try:
  1. Former smokers only
  2. COPD vs COPD+Cancer vs Healthy as compared to Cancer instead of COPD


```{r GlobalVariables, include=FALSE}
cacheOption = FALSE

```


```{r defineFunctions, include=FALSE}
foldChange <- function(eset, groups, genes){
  apply(exprs(eset)[genes, groups==0], 1, mean) - 
    apply(exprs(eset)[genes, groups==1], 1, mean)
}

medianFilter <- function(eset){
  md <- median(exprs(eset))
  passFilter <- logical(featureNumber(eset))
  for(i in 1:featureNumber(eset)){
    passFilter[i] <- sum(exprs(eset)[i, ] > md) > 0
  }
  
  eset <- eset[passFilter, ]
  return(eset)
  
}

```


```{r LoadData, echo=FALSE, cache=cacheOption, include=FALSE}
# set the working directory to the directory of this script
setwd("/restricted/projectnb/pulmarray/LinGA_protected/Allegro/COPD_Cancer/experiments/2014-09-03_Evans_Day")

# load the data using a script that removes patients with:
#  Cancer = NA
#  SMK    = 3
source("/protected/projects/pulmarray/Allegro/COPD_Cancer/scripts/AllegroSetup.R")

# clean the data (i.e. remove DKs and NAs)
eset <- removeFactorLevel(eset, "FinalCaDXc", "DK")
eset <- removeFactorLevel(eset, "AllegroCOPDc", "DK")
eset <- cleanNAForAnalysis(eset, "AGEcalc")
eset <- cleanNAForAnalysis(eset, "RIN")
eset <- removeBioReps(eset)
eset <- calcIndicator(eset, "FinalCaDXc", "AllegroCOPDc")

holdEset <- eset

library(znorm)

```

### GOAL 1: Analysis comparing COPD to COPD+Cancer group
```{r allegroCOPDvsCOPDCancerFormer, cache=cacheOption, fig.width=8,fig.height=7, fig.align='center'}

# Note: use the median filter only after final eset for analysis is formed

# CLEAN the data further
# remove the disease-free patients
eset <- holdEset
eset <- removeFactorLevel(eset, "indicator", "1")
# remove the Cancer-only patients
eset <- removeFactorLevel(eset, "indicator", "2")
esetF <- medianFilter(eset)

# ANALYSIS

# Analysis 1
#covariates1 <- c("FinalCaDXc", "SMKc", "AGEcalc", "RIN")
analysis1 <- lmFitWrapper(esetF, c("FinalCaDXc", "SMKc", "AGEcalc", "RIN"), 1, p.value=0.10)
analysis1a <- lmFitWrapper(analysis1$eset, c("FinalCaDXc", "SMKc", "AGEcalc", "RIN"), 1, p.value=0.15)

hMap1 <- generate_heatmap(analysis1$inds, analysis1$eset, tp="FinalCaDXc", mn="Analysis1")
hMap1a <- generate_heatmap(analysis1a$inds, analysis1a$eset, tp="FinalCaDXc", mn="Analysis1a")

#model1 <- model.matrix(~1 + FinalCaDXc + SMKc + AGEcalc + RIN, data=esetF)
#fit1 <- lmFit(esetF, model1)
#fit1 <- eBayes(fit1)
#results1 <- decideTests(fit1, adjust.method="fdr", p.value=0.10)
#summary(results1)

#inds1 <- which(results1[,2] != 0)
#hMap1 <- generate_heatmap(inds1, esetF, tp="FinalCaDXc")

# the COPD vs COPD+Cancer in formers only
eset <- removeFactorLevel(eset, "SMKc", "1")
esetF <- medianFilter(eset)
analysis2 <- lmFitWrapper(esetF, c("FinalCaDXc", "AGEcalc", "RIN"), 1, p.value=0.15)
hMap2 <- generate_heatmap(analysis2$inds, analysis2$eset, tp="FinalCaDXc", mn="Analysis2")

#model2 <- model.matrix(~1 + FinalCaDXc + AGEcalc + RIN, data=esetF)
#fit2 <- lmFit(esetF, model2)
#fit2 <- eBayes(fit2)
#results2 <- decideTests(fit2, adjust.method="fdr", p.value=0.15)
#summary(results2)

#inds2 <- which(results2[,2] != 0)
#geneSymbols2 <- fit2$genes$Symbol[inds2]
#hMap2 <- generate_heatmap(inds2, esetF, tp="FinalCaDXc")

```

The problem above seems to be related a block of patients in the COPD-only,
former smoker group that differ significantly from the rest of the former smokers. Could they possibly be current smokers? Try the above analysis with just current smokers

```{r allegroCOPDvsCOPDCancerCurrent, cache=cacheOption, fig.width=8,fig.height=7, fig.align='center'}

# Note: use the median filter only after final eset for analysis is formed

# CLEAN the data further
# remove the disease-free patients
eset <- holdEset
eset <- removeFactorLevel(eset, "indicator", "1")
# remove the Cancer-only patients
eset <- removeFactorLevel(eset, "indicator", "2")
eset <- removeFactorLevel(eset, "SMKc", "2")
esetF <- medianFilter(eset)

# ANALYSIS
analysis3 <- lmFitWrapper(esetF, c("FinalCaDXc", "AGEcalc", "RIN"), 1, p.value=0.25)
print("Try not correcting for multiple comparisons...")
analysis3a <- lmFitWrapper(esetF, c("FinalCaDXc", "AGEcalc", "RIN"), 1, adjust.method="none", p.value=0.01)
hMap3a <- generate_heatmap(analysis3a$inds, analysis3a$eset, tp="FinalCaDXc", mn="Analysis3a")

#design3 <- model.matrix(~1 + FinalCaDXc + AGEcalc + RIN, data=esetF)
#fit3 <- lmFit(esetF, design3)
#fit3 <- eBayes(fit3)
#results3 <- decideTests(fit3, adjust.method="fdr", p.value=0.25)
#summary(results3)
# nothing significant at FDR < 0.25

# try not correcting for comparisons
#results3 <- decideTests(fit3, adjust.method="none", p.value=0.01)
#summary(results3)

#inds3 <- which(results3[,2] != 0)
#generate_heatmap(inds3, esetF, tp="FinalCaDXc")

```


### GOAL 2: Analysis of COPD+Cancer vs. everyone in formers only
```{r COPDCancerVAll, fig.width=8, fig.height=7, fig.align='center', cache=cacheOption}
eset <- holdEset
eset$AllOrNone <- eset$indicator
eset$AllOrNone[eset$indicator != 4] <- 1
eset <- removeFactorLevel(eset, "AllOrNone", "2")
eset <- removeFactorLevel(eset, "AllOrNone", "3")
esetF <- medianFilter(eset)

analysis4 <- lmFitWrapper(esetF, c("AllOrNone", "SMKc", "AGEcalc", "RIN"), 1, p.value=0.05)
hMap4 <- generate_heatmap(analysis4$inds, analysis4$eset, tp="indicator", mn="Analysis4")


#design4 <- model.matrix(~1 + AllOrNone + SMKc + AGEcalc + RIN, data=esetF)
#fit4 <- lmFit(esetF, design4)
#fit4 <- eBayes(fit4)
#results4 <- decideTests(fit4, adjust.method="fdr", p.value=0.05)
#summary(results4)
#inds4 <- which(results4[, 2] != 0)

#generate_heatmap(inds4, esetF, tp="indicator")

# try the AllOrNone approach in only former smokers
eset <- removeFactorLevel(eset, "SMKc", "1")
esetF <- medianFilter(eset)

analysis5 <- lmFitWrapper(esetF, c("AllOrNone", "AGEcalc", "RIN"), 1, p.value=0.01)
hMap5 <- generate_heatmap(analysis5$inds, analysis5$eset, tp="indicator", mn="Analysis5")

#design5 <- model.matrix(~1 + AllOrNone + AGEcalc + RIN, data=esetF)
#fit5 <- lmFit(esetF, design5)
#fit5 <- eBayes(fit5)
#results5 <- decideTests(fit5, adjust.method="fdr", p.value=0.01)
#summary(results5)

#inds5 <- which(results5[, 2] != 0)
#generate_heatmap(inds5, esetF, tp="indicator")

```

There appears to be a lot of heterogeneity related to the signal above even though there are many significant genes. Try this in the PFT-defined COPD cohort only

```{r COPDCancerVAllPFT, fig.width=8, fig.height=7, fig.align='center', cache=cacheOption}
eset <- holdEset
eset <- cleanNAForAnalysis(eset, "COPD2_R7")
eset <- removeFactorLevel(eset, "COPD2_R7", "DK")
eset <- calcIndicator(eset, "FinalCaDXc", "COPD2_R7")
eset$AllOrNone <- eset$indicator
eset$AllOrNone[eset$indicator != 4] <- 1
eset <- removeFactorLevel(eset, "AllOrNone", "2")
eset <- removeFactorLevel(eset, "AllOrNone", "3")
esetF <- medianFilter(eset)

analysis6 <- lmFitWrapper(esetF, c("AllOrNone", "SMKc", "AGEcalc", "RIN"), 1, p.value=0.25)
hMap6 <- generate_heatmap(analysis6$inds, analysis6$eset, tp="indicator")

#design6 <- model.matrix(~1 + AllOrNone + SMKc + AGEcalc + RIN, data=esetF)
#fit6 <- lmFit(esetF, design6)
#fit6 <- eBayes(fit6)
#results6 <- decideTests(fit6, adjust.method="fdr", p.value=0.25)
#summary(results6)

#inds6 <- which(results6[, 2] != 0)
#generate_heatmap(inds6, esetF, tp="indicator")

# still very heterogenous signal based on smoking
# remove the current smokers and run the above (model6) only in formers
eset <- removeFactorLevel(eset, "SMKc", "1")
esetF <- medianFilter(eset)

analysis7 <- lmFitWrapper(esetF, c("AllOrNone", "AGEcalc", "RIN"), 1, p.value=0.25)
hMap7 <- generate_heatmap(analysis7$inds, analysis7$eset, tp="indicator")
#model7 <- model.matrix(~1 + AllOrNone + AGEcalc + RIN, data=esetF)
#fit7 <- lmFit(esetF, model7)
#fit7 <- eBayes(fit7)
#results7 <- decideTests(fit7, adjust.method="fdr", p.value=0.25)
#summary(results7)

#inds7 <- which(results7[, 2] != 0)
#generate_heatmap(inds7, esetF, tp="indicator")

# There appears to be a gradient among the disease-free and cancer-only 
# groups; try including PY 

eset <- cleanNAForAnalysis(eset, "PYc")
esetF <- medianFilter(eset)

analysis8 <- lmFitWrapper(esetF, c("AllOrNone", "AGEcalc", "RIN", "PYc"), 1, p.value=0.25)
hMap8 <- generate_heatmap(analysis8$inds, analysis8$eset, tp="indicator")

#model8 <- model.matrix(~1 + AllOrNone + AGEcalc + RIN + PYc, data=esetF)
#fit8 <- lmFit(esetF, model8)
#fit8 <- eBayes(fit8)
#results8 <- decideTests(fit8, adjust.method="fdr", p.value=0.25)
#summary(results8)

#inds8 <- which(results8[, 2] != 0)
#generate_heatmap(inds8, esetF, tp="indicator")

# the above appears more homogenous within each group but gender now
# appears to be playing a role

eset <- removeFactorLevel(eset, "GENDERc", "DK")
esetF <- medianFilter(eset)

analysis9 <- lmFitWrapper(esetF, c("AllOrNone", "AGEcalc", "RIN", "PYc", "GENDERc"), 1, p.value=0.15)
hMap9 <- generate_heatmap(analysis9$inds, analysis9$eset)

#model9 <- model.matrix(~1 + AllOrNone + AGEcalc + RIN + PYc + GENDERc, data=esetF)
#fit9 <- lmFit(esetF, model9)
#fit9 <- eBayes(fit9)
#results9 <- decideTests(fit9, adjust.method="fdr", p.value=0.15)
#summary(results9)

#inds9 <- which(results9[, 2] != 0)

clusters9 <- return_cluster(analysis9$inds, analysis9$eset, n.clusters=2)

generate_heatmap(analysis9$inds, analysis9$eset, tp="indicator", mn="Model9")
generate_heatmap(analysis9$inds[clusters9==1], analysis9$eset, tp="indicator", mn="Model9Up")
generate_heatmap(analysis9$inds[clusters9==2], analysis9$eset, tp="indicator", mn="Model9Down")

save_entrez(analysis9$inds[clusters9==1], rownames(analysis9$eset), filename="AllOrNoneUP.AGERINPYGENDER.txt")
save_entrez(analysis9$inds[clusters9==2], rownames(analysis9$eset), filename="AllOrNoneDOWN.AGERINPYGENDER.txt")

# TEST THE 50 UP GENES
testUPCOPDCancervCOPD <- t.test(exprs(analysis9$eset)[analysis9$inds[clusters9==1], analysis9$eset$indicator==3], exprs(analysis9$eset)[analysis9$inds[clusters9==1], analysis9$eset$indicator==4])
testUPCOPDCancervCOPD

testUPCOPDCancervCancer <- t.test(exprs(analysis9$eset)[analysis9$inds[clusters9==1], analysis9$eset$indicator==2], exprs(analysis9$eset)[analysis9$inds[clusters9==1], analysis9$eset$indicator==4])
testUPCOPDCancervCancer

testUPCOPDCancervDiseaseFree <- t.test(exprs(analysis9$eset)[analysis9$inds[clusters9==1], analysis9$eset$indicator==1], exprs(analysis9$eset)[analysis9$inds[clusters9==1], analysis9$eset$indicator==4])
testUPCOPDCancervDiseaseFree

# TEST THE 38 DOWN GENES
testDOWNCOPDCancervCOPD <- t.test(exprs(analysis9$eset)[analysis9$inds[clusters9==2], analysis9$eset$indicator==3], exprs(analysis9$eset)[analysis9$inds[clusters9==2], analysis9$eset$indicator==4])
testDOWNCOPDCancervCOPD

testDOWNCOPDCancervCancer <- t.test(exprs(analysis9$eset)[analysis9$inds[clusters9==2], analysis9$eset$indicator==2], exprs(analysis9$eset)[analysis9$inds[clusters9==2], analysis9$eset$indicator==4])
testDOWNCOPDCancervCancer

testDOWNCOPDCancervDiseaseFree <- t.test(exprs(analysis9$eset)[analysis9$inds[clusters9==2], analysis9$eset$indicator==1], exprs(analysis9$eset)[analysis9$inds[clusters9==2], analysis9$eset$indicator==4])
testDOWNCOPDCancervDiseaseFree

# Try limiting cancer to Squamous only - careful about coercion to NA
eset2 <- eset
eset$squamous <- rep(2, sampleNumber(eset))
eset$squamous[which(eset$CA_SUB_CELL_TYPE=="Squamous")] <- 1
eset$squamous[which(eset$FinalCaDXc==0)] <- 0
eset$squamous <- factor(eset$squamous)
eset <- removeFactorLevel(eset, "squamous", "2")
esetF <- medianFilter(eset)

analysis10 <- lmFitWrapper(esetF, c("AllOrNone", "AGEcalc", "RIN", "PYc", "GENDERc"), 1, p.value=0.05)
hMap10 <- generate_heatmap(analysis10$inds, analysis10$eset, tp="indicator", mn="Analysis10")

#model10 <- model.matrix(~1 + AllOrNone + AGEcalc + RIN + PYc + GENDERc, data=esetF)
#fit10 <- lmFit(esetF, model10)
#fit10 <- eBayes(fit10)
#results10 <- decideTests(fit10, adjust.method="none", p.value=0.05)
#summary(results10)

# to me these results are suggestive of the idea I had earlier - 
# that there are some 'former' smokers who ought to be characterized as currents

```

Call smoker status by molecular profile
```{r correctingSmoking, fig.width=8, fig.height=7, fig.align='center', cache=cacheOption}

eset <- holdEset

# load smoking related genes; of interest are genes up in current smokers
smokerGenes <- read.table("../../geneSubsets//pnas_genome_biology_smokers_genesets.gmx", fill=TRUE, head=TRUE)

down_in_smokers_PNAS <- smokerGenes$Down_In_Smokers_PNAS
up_in_smokers_PNAS <- smokerGenes$Up_In_Smokers_PNAS
down_in_current_smokers_genome_biology <- smokerGenes$Down_In_Current_Smokers_Genome_Biology
up_in_current_smokers_genome_biology <- smokerGenes$Up_In_Current_Smokers_Genome_Biology

down_in_smokers_PNAS <- down_in_smokers_PNAS[down_in_smokers_PNAS!="" & down_in_smokers_PNAS!="na"]
up_in_smokers_PNAS <- up_in_smokers_PNAS[up_in_smokers_PNAS!="" & up_in_smokers_PNAS!="na"]
down_in_current_smokers_genome_biology <- down_in_current_smokers_genome_biology[down_in_current_smokers_genome_biology!="" & down_in_current_smokers_genome_biology!="na"]
up_in_current_smokers_genome_biology <- up_in_current_smokers_genome_biology[up_in_current_smokers_genome_biology!="" & up_in_current_smokers_genome_biology!="na"]

model10 <- model.matrix(~1 + SMKc, data=eset)
fit10 <- lmFit(eset, model10)
fit10 <- eBayes(fit10)
results10 <- decideTests(fit10, adjust.method="fdr", p.value=0.05)

upCurrentGBinds <- match(up_in_current_smokers_genome_biology, fit10$genes$Symbol)
upCurrentGBinds <- upCurrentGBinds[!is.na(upCurrentGBinds)]

generate_heatmap(upCurrentGBinds, eset, tp="indicator")


pcaSMK <- prcomp(znorm(x=exprs(eset)[upCurrentGBinds, ], margin=1), center=FALSE, scale.=FALSE)
plot(pcaSMK$rotation[, 1], pcaSMK$rotation[, 2], col=eset$SMKc, 
     main="PC1, PC2 of 23 genes up in current smokers (Gen. Biol.)",
     xlab="PC1", ylab="PC2")
legend("topright", c("Former", "Current"), fill=eset$SMKc)

library(mclust)

mClustMod1 <- Mclust(pcaSMK$rotation[, 1])
plot(mClustMod1, "BIC", cex.axis=1)
plot(mClustMod1, "classification", cex.axis=1)
plot(mClustMod1, "uncertainty", cex.axis=1)
plot(mClustMod1, "density", cex.axis=1)

cor(mClustMod1$classification, as.numeric(eset$SMKc))

qs4 <- quantile(mClustMod1$uncertainty)
qs10 <- quantile(mClustMod1$uncertainty, probs=seq(0,1,0.1))

recodeSMK <- factor(eset$SMKc, levels=c(levels(eset$SMKc), "uncertain"))
recodeSMK[mClustMod1$uncertainty>qs10[10]] <- "uncertain"

recodeSMK_colors <- c("1"="red", "2"="blue", "uncertain"="darkgrey");
plot(pcaSMK$rotation[, 1], pcaSMK$rotation[, 2], col=recodeSMK_colors[recodeSMK], 
     main="PC1, PC2 of 23 genes up in current smokers (Gen. Biol.)",
     xlab="PC1", ylab="PC2")
legend("topright", c("Former", "Current", "Uncertain"), fill=recodeSMK_colors)

recodeSMK2 <- mClustMod1$classification
recodeSMK2[mClustMod1$uncertainty>qs10[10]] <- "uncertain"
recodeSMK2 <- factor(recodeSMK2)
eset$SMK2 <- recodeSMK2

plot(pcaSMK$rotation[, 1], pcaSMK$rotation[, 2], col=recodeSMK_colors[recodeSMK2], 
     main="PC1, PC2 of 23 genes up in current smokers (Gen. Biol.)",
     xlab="PC1", ylab="PC2")
legend("topright", c("Former", "Current", "Uncertain"), fill=recodeSMK_colors)
```
## questions  
1. remove those patients seemingly misclassified or just re-classify?
2. what percentage of unclear patients should I remove?



## Run analysis with new smoking coding and compare to COPDvCOPD+Cancer from model 2
```{r newSmokingCalls}

eset <- holdEset
eset <- removeFactorLevel(eset, "indicator", "1")
eset <- removeFactorLevel(eset, "indicator", "2")
eset <- removeFactorLevel(eset, "SMKc", "1")
esetF <- medianFilter(eset)
model11 <- model.matrix(~1 + FinalCaDXc + AGEcalc + RIN, data=esetF)
fit11 <- lmFit(esetF, model11)
fit11 <- eBayes(fit11)
results11 <- decideTests(fit11, adjust.method="fdr", p.value=0.15)
summary(results11)

inds11 <- which(results11[,2] != 0)
# This will produce the same heatmap as before
generate_heatmap(inds11, esetF, tp="FinalCaDXc")
# save these genes out as gene symbols
save_entrez(inds11, rownms=fit11$genes$Symbol, filename="tempgeneSymbols.model11.COPDvCOPDCancer.txt")
# Now show same map but with new smoking status
esetTemp <- esetF
esetTemp$SMKc <- esetTemp$SMK2
generate_heatmap(inds11, esetTemp, tp="FinalCaDXc")

clabelsT <- cbind("FinalCaDXc" = cancer_colors[esetTemp$FinalCaDXc],
                 "Smoking Status" = recodeSMK_colors[esetTemp$SMKc],
                 "Gender" = gender_colors[esetTemp$GENDERc])
 
heatmap3(esetTemp[inds11,], col = bluered,
         hclustfun=function(d) hclust(d, method="average"),
         col.clustering = esetTemp$FinalCaDXc, ColSideColors = clabelsT,
         main = "Molecular Smoking Codes, COPD v COPD+Cancer")

# Try running same model now but with updated smoking status and removing 'uncertain'
eset <- holdEset
eset$SMK2 <- recodeSMK2
eset <- removeFactorLevel(eset, "indicator", "1")
eset <- removeFactorLevel(eset, "indicator", "2")
eset <- removeFactorLevel(eset, "SMK2", "1")
eset <- removeFactorLevel(eset, "SMK2", "uncertain")
esetF <- medianFilter(eset)

model12 <- model.matrix(~1 + FinalCaDXc + AGEcalc, data=esetF)
fit12 <- lmFit(esetF, model12)
fit12 <- eBayes(fit12)
results12 <- decideTests(fit12, adjust.method="fdr", p.value=0.2)
summary(results12)

inds12 <- which(results12[, 2] != 0)
geneSymbols12 <- fit12$genes$Symbol[inds12]
esetF$SMKc <- esetF$SMK2
generate_heatmap(inds12, esetF, tp="FinalCaDXc")

# The results from above (model2) that indicate at least two distinct clusters of patients
# within each of the COPD and COPD+Cancer groups seems to be replicated here
# Need to check if the clusters are similar or the same

# try using pca with mclust to define clusters within each disease group

pca12 <- prcomp(znorm(x=exprs(esetF)[inds12, ], margin=1), center=FALSE, scale.=FALSE)

clusters12 <- factor(return_cluster(inds12, esetF, n.clusters=4,
                                    type=COLUMNS, colClus=esetF$FinalCaDXc))

clabelsT <- cbind("FinalCaDXc" = cancer_colors[esetF$FinalCaDXc],
                 "Smoking Status" = recodeSMK_colors[esetF$SMK2],
                 "Gender" = gender_colors[esetF$GENDERc],
                  "Cluster" = copdca_colors[clusters12])

hMapTemp <- heatmap3(eset[inds12,], col = bluered,
                     hclustfun=function(d) hclust(d, method="average"),
                     col.clustering = esetF$FinalCaDXc, ColSideColors = clabelsT,
                     main = "Molecular Smoking Codes, COPD and COPD+Cancer Unsupervised",
                     keep.dendro=TRUE)

clusters12 <- cutree(as.hclust(hMapTemp$Colv), h=2)
hMapTemp2 <- heatmap3(eset[inds12,], col = bluered,
                     hclustfun=function(d) hclust(d, method="average"),
                     col.clustering = esetF$FinalCaDXc, ColSideColors = clabelsT,
                     main = "Molecular Smoking Codes, COPD and COPD+Cancer Unsupervised")

eset <- removeFactorLevel(eset, "SMKnew", "uncertain")
eset <- removeFactorLevel(eset, "COPD2_R7", "DK")
eset <- cleanNAForAnalysis(eset, "COPD2_R7")
eset <- calcIndicator(eset, "FinalCaDXc", "COPD2_R7")

model11 <- model.matrix(~1 + FinalCaDXc*AGEcalc + RIN, data=eset)
fit11 <- lmFit(eset, model11)
fit11 <- eBayes(fit11)
results11 <- decideTests(fit11, adjust.method="fdr", p.value=0.15)

```




