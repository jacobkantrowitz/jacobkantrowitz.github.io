Using Nature Medicine (2007) Data to Validate COPD:Cancer Interaction Signal
===============================================================================
`r Sys.Date()`
---------------------------------------------
In this script I will be attempting to validate the gene list generated in the Allegro data
that represents a possible signal for the interaction bewteen COPD and lung cancer
That list was generated by overlapping the results from several models
  : COPD/FEV1/RATIO +/- PY +/- SMK
Here I will attempt validation with several methods
  1. Create a linear model the same way from the initial analysis and check p-value for interaction
    - as the p-values originally were all < 0.05 (uncorrected) we do not need to run all genes
  2. Run same analyses and generate ranked list for each analysis - run GSEA
  
Other validation required:
  1. validate cancer signal in Allegro enriched for Nature Medicine (2007)
  2. validate COPD signal in Allegro enriched for Blue Journal (2013)

```{r DataSetup}
library("GEOquery")

gse <- getGEO(filename="/restricted/projectnb/pulmarray/Airway_Metanalysis/data/original/NatMed/GSE4115_series_matrix.txt.gz", GSEMatrix=TRUE)

anns <- read.csv("/protected/projects/pulmarray/Allegro/COPD_Cancer/nature_medicine_annotations/100512_natmed_annotations_with_copd.txt",
                 sep="\t")

mergeAnns <- merge(pData(gse), anns, by.x="geo_accession", by.y="GEO_ID")
pftAnns <- mergeAnns[!is.na(mergeAnns$COPD), ]

pftGSE <- gse[, match(pftAnns$geo_accession, pData(gse)$geo_accession)]
pData(pftGSE) <- pftAnns

holdEset <- pftGSE

# load the gene set of interest
geneSetOverlap <- read.table("/protected/projects/pulmarray/Allegro/COPD_Cancer/experiments/lam/Genes2013AllOverlap_71_p05_010715.txt",
                             col.names="geneSymbol",
                             as.is=TRUE)

setwd("/protected/projects/pulmarray/Allegro/COPD_Cancer/experiments/Nature_Medicine_Validation/")

# make sure the expression set variables are the correc types
holdEset$COPD <- as.factor(holdEset$COPD)
holdEset$Cancer <- relevel(holdEset$Cancer, "No Cancer")

natmed <- holdEset

source("/protected/projects/pulmarray/Allegro/COPD_Cancer/scripts/AllegroSetup.R")
allegro <- eset

```

```{r defineFunctions, include=FALSE}
foldChange <- function(eset, groups, genes){
  apply(exprs(eset)[genes, groups==0], 1, mean) - 
    apply(exprs(eset)[genes, groups==1], 1, mean)
}

medianFilter <- function(eset){
  md <- median(exprs(eset))
  passFilter <- logical(featureNumber(eset))
  for(i in 1:featureNumber(eset)){
    passFilter[i] <- sum(exprs(eset)[i, ] > md) > 0
  }
  
  eset <- eset[passFilter, ]
  return(eset)
  
}

saveGeneList <- function(analysis, filename=paste(Sys.Date(), "Temp", analysis$name, ".txt", sep="")){
  
  write.table(analysis$geneSymbols, file=filename, quote=FALSE,row.names=FALSE, col.names=FALSE)

}
```


The data lacks annotation regarding current/former smoking status
I will use the PNAS and/or Genome Biology signatures to generate binary
scores. Alternatively I can generate a scores (e.g. PC1) and use that 
instead
```{r GenerateSmokingAnnotation}
geneSubsets <- "/protected/projects/pulmarray/Allegro/COPD_Cancer/geneSubsets/"

pnas <- read.csv(paste(geneSubsets, "pnas_genome_biology_smokers_genesets.gmx", sep=""), sep="\t")

updatedExposure <- read.csv(paste(geneSubsets, "pnas_genome_biology_smokers_genesets.gmx", sep=""), sep="\t")


library(mclust)
pnasDownCurr <- as.character(pnas[,3])
pnasDownCurr <- pnasDownCurr[pnasDownCurr!=""]
pnasDownCurr <- pnasDownCurr[pnasDownCurr!="na"]

pnasUpCurr <- as.character(pnas[, 4])
pnasUpCurr <- pnasUpCurr[pnasUpCurr!=""]
pnasUpCurr <- pnasUpCurr[pnasUpCurr!="na"]

pnasCurr <- c(pnasUpCurr, pnasDownCurr)

# need to match up the Gene Symbols I have to natmed data
eset <- natmed
setup1 <- lmFitWrapper(eset,
                            c("COPD", "Cancer", "Age..yr.",
                              "Gender", "Packyears", "COPD*Cancer"),
                            name="Validation 1 - All Smokers - SMK",
                            adjust.method="none", p.value=0.05,
                            varOfInterest=6)

natmedCurrSmokeInds <- match(pnasCurr, setup1$fit$genes$"Gene Symbol")
natmedCurrSmokeInds <- natmedCurrSmokeInds[!is.na(natmedCurrSmokeInds)]

natmedCurrData <- natmed[natmedCurrSmokeInds, ]

# try feeding in all of the data to Mclust and separating into two groups
# make sure it is clustering patients
smoking <- Mclust(t(exprs(natmedCurrData)), G=2)
eset$SmokingClustPNAS <- as.factor(smoking$classification)

validation1Test <- lmFitWrapper(eset,
                            c("COPD", "Cancer", "Age..yr.",
                              "Gender", "Packyears",
                              "SmokingClustPNAS", "COPD*Cancer"),
                            name="Validation 1 - SMK + packyears",
                            adjust.method="none", p.value=0.05,
                            varOfInterest=7)

# compare to geneSetOverlap
validationGenes <- validation1Test$fit$genes$"Gene Symbol"[validation1Test$inds]
validationGenes <- as.character(validationGenes)
validationGenes <- validationGenes[validationGenes!=""]
sum(validationGenes %in% as.character(geneSetOverlap[[1]]))
which(validationGenes %in% as.character(geneSetOverlap[[1]]))
validationGenes[which(validationGenes %in% as.character(geneSetOverlap[[1]]))]

validation2Test <- lmFitWrapper(eset,
                            c("COPD", "Cancer", "Age..yr.",
                              "Gender",
                              "SmokingClustPNAS", "COPD*Cancer"),
                            name="Validation 2 - SMK, no packyears",
                            adjust.method="none", p.value=0.05,
                            varOfInterest=6)

validationGenes2 <- validation2Test$fit$gene$"Gene Symbol"[validation2Test$inds]
validationGenes2 <- as.character(validationGenes2)
validationGenes2 <- validationGenes2[validationGenes2!=""]
sum(validationGenes2 %in% as.character(geneSetOverlap[[1]]))
which(validationGenes2 %in% as.character(geneSetOverlap[[1]]))
validationGenes2[which(validationGenes2 %in% as.character(geneSetOverlap[[1]]))]

validation3Test <- lmFitWrapper(eset,
                            c("COPD", "Cancer", "Age..yr.",
                              "Gender", "Packyears", "COPD*Cancer"),
                            name="Validation 3 - no SMK term",
                            adjust.method="none", p.value=0.05,
                            varOfInterest=6)
validationGenes3 <- validation3Test$fit$gene$"Gene Symbol"[validation3Test$inds]
validaitonGenes3 <- as.character(validationGenes3)
validationGenes3 <- validationGenes3[validationGenes3!=""]

sum(validationGenes3 %in% as.character(geneSetOverlap[[1]]))
which(validationGenes3 %in% as.character(geneSetOverlap[[1]]))

# how about the overlap between the three natmed models?
sum(validationGenes2 %in% validationGenes)
which(validationGenes2 %in% validationGenes)
vG1in2 <- validationGenes2[which(validationGenes2 %in% validationGenes)]

sum(vG1in2 %in% validationGenes3)
which(vG1in2 %in% validationGenes3)
vG12in3 <- vG1in2[which(vG1in2 %in% validationGenes3)]

#write.table(vG12in3, file=paste("Temp013015.natmedOverlap.p05.631Genes.txt"), quote=FALSE,row.names=FALSE, col.names=FALSE)

# write out a ranked list for the interaction term from the 3rd model
write.table(validation3Test$fit$t[, 7], file="interaction_ranked_list.rnk",quote=FALSE, col.names=FALSE)

# try looking at only those genes that overlap between the genes of interest
# and the available genes in the natmed data
overlapInds <- match(as.character(geneSetOverlap[[1]]), validation3Test$fit$genes$"Gene Symbol")
overlapInds <- overlapInds[!is.na(overlapInds)]
eset <- eset[]

```


```{r Validation1}
#library(znorm)
#library(mclust)

# analysis 1 will model gene ~ copd + cancer + age + gender + PY + smoking + copd:cancer
# in all patients, except here smoking status is not defined as > 30 days since quit (10 years)
# should we establish a molecular type for smoking status and assign binary values?
eset <- holdEset
validation1 <- lmFitWrapper(eset, c("COPD", "Cancer", "Age..yr.",
                                       "Gender", "Packyears", "COPD*Cancer"),
                               name="Validation 1 - All Smokers - SMK",
                               adjust.method="none", p.value=0.05,
                               varOfInterest=6)




```




