COPD:Cancer Interaction, ATF4, EMT, ECM
===============================================================================
`r Sys.Date()`
---------------------------------------------

I'm going to go back to the interaction list generated by the mean of t-statistics from the 3 models motivated by Katie's work.
I will generate a ranked list and genes lists at various FDR thresholds.
From there I will use GSEA to check for enrichment of the EMT signature from the NSCLC paper, the ATF4 signature from Ben, and the tumor signal from Katie

I need to read the EMT paper. I would also like to find an ECM gene signature
Look at the gastric cancer EMT, UPR paper
Regenerate PC plot of all cancers ([from Byers EMT paper](http://www.ncbi.nlm.nih.gov/pubmed/23091115))
EGFR mutations were only in the epithelial group, while KRAS mutations were more common in the mesenchymal group
Eventually could recreate their anlaysis by findings genes correlated with at least one of the 4 EMT markers, E-cadherin (CDH1), vimentin (VIM), N-cadherin (CDH2), or fibronectin (FN1)
The [gastric paper](http://www.ncbi.nlm.nih.gov/pubmed/25502090) showed that severe hypoxia induced EMT of gastric cancer cells. Additionally, PERK, ATF4, ATF6 were all elevated in cells under severe hypoxia (this is their purpose, no?). Knockdown of PERK, ATF4, or ATF6 impeded EMT of gastric cancer cells induced by severe hypoxia. E-cadherin decreased from normoxia to hypoxia to severe hypoxia, while vimentin increased conversely. TGF-beta was also increased by severe hypoxia, but its increase was blocked by knockdown of the 3 UPR genes. TGF-beta increase in severe hypoxia led to activation of SMAD2/3 and PI3K/Akt signaling.
Interesting to look at these genes (PERK, ATF4, ATF6, CHD1, CDH2, FN1, VIM, SMAD2/3, PI3K/Akt pathways), especially in former smokers by disease

<h4>CBM Presentation<h4>
Will have to go into some background but nothing too extensive. Take some from quals. Also add the Powell UK study and reference to Young '09 and Skillrud '86.



1. generate 3x COPD:Cancer interaction models
2. Generate ranked list for each of 3x models
3. Create a merged ranked list by taking the mean of the 3 t-stats
4. Optionally, take the t-stat of the t-stats
5. Generate gene signature from COPD:Cancer interaction
5. Visualize genes of signature by heatmap
5. Use ATF4 Data to generate ATF4 up/down signatures
6. Generate ranked list for ATF4
7. Use EMT gene signature and visualize cancers only
8. Test EMT signature by chi-squared test
9. Find ECM gene(s) signature
10. Look at Katie's gene signature in the tumor and compare to the airway
11. GSEA the interaction into ATF4, EMT, and tumor signatures or vice-versa
12. visualize the signatures by heatmap and PCA, especially in cancers

ECM genes related to COPD]()
  
```{r defineFunctions, include=FALSE}
foldChange <- function(eset, groups, genes){
  apply(exprs(eset)[genes, groups==0], 1, mean) - 
    apply(exprs(eset)[genes, groups==1], 1, mean)
}

medianFilter <- function(eset){
  md <- median(exprs(eset))
  passFilter <- logical(featureNumber(eset))
  for(i in 1:featureNumber(eset)){
    passFilter[i] <- sum(exprs(eset)[i, ] > md) > 0
  }
  
  eset <- eset[passFilter, ]
  return(eset)
  
}

saveGeneList <- function(analysis, filename=paste(Sys.Date(), "Temp", analysis$name, ".txt", sep="")){
  
  write.table(analysis$geneSymbols, file=filename, quote=FALSE,row.names=FALSE, col.names=FALSE)

}

saveRankedList <- function(fit, varColInd, filename = "tempRankedList"){
  filename = paste(paste(Sys.Date(), colnames(fit$t)[varColInd], filename, sep="_"), "rnk", sep=".")
  print(filename)
  temp <- data.frame(geneSymbols = fit$genes$Symbol, ts = fit$t[, varColInd])
  write.table(temp, file=filename, row.names=FALSE, quote=FALSE, col.names=TRUE, sep="\t", eol="\n")
  
  
}

saveGeneSet <- function(fit, inds, filename = "tempGeneSet", geneSetName="GeneSet", description=""){
  filename = paste(paste(Sys.Date(), filename, sep="_"), "gmx", sep=".")
  print(filename)
  temp <- data.frame(geneSymbols=c(geneSetName, description, fit$genes$Symbol[inds]))
  write.table(temp, file=filename, row.names=FALSE, quote=FALSE, col.names=FALSE)
  
}
```

```{r setup, eval=TRUE, echo=TRUE, include=FALSE, results='hide'}

setwd("/protected/projects/pulmarray/Allegro/COPD_Cancer/experiments/2015-04-29_CBM_ATS_2015/")
source("/protected/projects/pulmarray/Allegro/COPD_Cancer/scripts/AllegroSetup.R")
# fix the one patient with wonky data
# eventually this should just be saved in the RDS file
holdEset <- eset
holdEset$FEV1Pc[holdEset$FEV1Pc==89.2] <- 0.892

emt_genes <- read.csv("/protected/projects/pulmarray/Allegro/COPD_Cancer/geneSubsets/emt_gene_symbols_byers_2013.csv", header=FALSE)
temp <- as.factor(unique(as.character(emt_genes$V1)))
emt_genes <- data.frame("EMT_Genes" = temp)

GOLD_colors = c("0" = "gray100", "1" = "gray75", "2" = "gray50", "3" = "gray25", "4" = "black")

# load ATF4 BEASB2 gene perturbation data for analysis
atf4_data <- readRDS("/protected/projects/pulmarray/Allegro/ATF4/ATF4data_2015MAR17_ExpressionSet.rds")
library(znorm)



```

```{r cleanup}

# Remaining question - should we keep or remove the COPD GOLD Status 1 patients? i.e. mild disease
# What about patients using or their charts indicating they have used corticosteroids?
esetClean <- holdEset
esetClean <- cleanNAForAnalysis(esetClean, "COPD2_R7")
esetClean <- cleanNAForAnalysis(esetClean, "RATIOc")
esetClean <- cleanNAForAnalysis(esetClean, "PYc")
esetClean <- cleanNAForAnalysis(esetClean, "RIN")
esetClean <- removeFactorLevel(esetClean, "COPD2_R7", "DK")
esetClean <- removeFactorLevel(esetClean, "FinalCaDXc", "DK")
esetClean <- removeFactorLevel(esetClean, "COPD2_R7", "DK")
esetClean <- removeFactorLevel(esetClean, "GENDERc", "DK")

esetClean <- calcIndicator(esetClean, "FinalCaDXc", "COPD2_R7")
esetClean$smkindic <- as.numeric(as.character(esetClean$indicator))
esetClean$smkindic[esetClean$SMKc==2] <- esetClean$smkindic[esetClean$SMKc==2] + 4
esetClean$smkindic <- as.factor(esetClean$smkindic)

# Define the GOLD Stage appropriate for all patients
esetClean$GOLD <- factor(x=rep(0, sampleNumber(esetClean)), levels=c("0","1","2","3","4"))
# GOLD Stage 1 Ratio < 0.7, FEV1 >= 8
esetClean$GOLD[esetClean$RATIOc < 0.7 & esetClean$FEV1Pc >= 0.8] <- 1
# GOLD Stage 2 Ratio < 0.7, 50 <= FEV1 < 80
esetClean$GOLD[esetClean$RATIOc < 0.7 & esetClean$FEV1Pc < 0.8] <- 2
# GOLD Stage 3 Ratio < 0.7, 30 <= FEV1 <= 50
esetClean$GOLD[esetClean$RATIOc < 0.7 & esetClean$FEV1Pc < 0.5] <- 3
# GOLD Stage 4 Ratio < 0.7, FEV1 < 30%
esetClean$GOLD[esetClean$RATIOc < 0.7 & esetClean$FEV1Pc < 0.3] <- 4

# Generate a super clean dataset devoid of all patients with other pulmonary diseases
esetSuperClean <- esetClean
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroPNAc", "1")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroTBc", "1")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroSarcoidc", "1")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroIPFc", "1")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroIPFc", "DK")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroAtelectasisc", "1")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroAtelectasisc", "DK")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroAsthmac", "DK")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroAsthmac", "1")

# clean up ATF4 data
varLabels(atf4_data) <- "SampleID"
atf4_data$SampleID[grep("ATF4", atf4_data$SampleID)] <- "ATF4"
atf4_data$SampleID[grep("Ctrl", atf4_data$SampleID)] <- "Control"
atf4_data$SampleID <- as.factor(atf4_data$SampleID)


```


```{r modelCreation, eval=TRUE, echo=TRUE, results='hide'}

# Katie uses age, sex, smoking, and pack years
# She also attempts to account for corticosteroids by removing them, repeating
# the analysis and checking for enrichment in the overlapping genes


fdrVals <- c(0.05, 0.1, 0.2)
intrxA <- list()
intrxB <- list()
intrxC <- list()
intrxGenes <- list()

#eset <- medianFilter(removeFactorLevel(esetClean, "SMKc", "1"))
eset <- medianFilter(esetClean)
for(i in 1:length(fdrVals)){
  
	intrxA[[i]] <- lmFitWrapper(eset, c("COPD2_R7", "FinalCaDXc", "AGEcalc", "SMKc",
                                     "GENDERc", "PYc", "RIN",
                                    "COPD2_R7*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method="fdr", p.value=fdrVals[i],
                             varOfInterest=8)
                             
	intrxB[[i]] <- lmFitWrapper(eset, c("FEV1Pc", "FinalCaDXc", "AGEcalc", "SMKc",
                                     "GENDERc", "PYc", "RIN",
                                     "FEV1Pc*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method="fdr", p.value=fdrVals[i],
                             varOfInterest=8)

	intrxC[[i]] <- lmFitWrapper(eset, c("RATIOc", "FinalCaDXc", "AGEcalc", "SMKc",
                                     "GENDERc", "PYc", "RIN",
                                     "RATIOc*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method="fdr", p.value=fdrVals[i],
                             varOfInterest=8)

	overlappingGenes <- intrxA[[i]]$geneSymbols[intrxA[[i]]$geneSymbols %in% intrxB[[i]]$geneSymbols]
	intrxGenes[[i]] <- overlappingGenes[overlappingGenes %in% intrxC[[i]]$geneSymbols]

	length(intrxA[[i]]$geneSymbols)
	length(intrxB[[i]]$geneSymbols)
	length(intrxC[[i]]$geneSymbols)
	length(intrxGenes[[i]])
	
}


# generate ATF4 models

atf4Model <- lmFitWrapper(atf4_data, c("SampleID"), name="ATF4 Perturbation Data", adjust.method="fdr",
                          p.value=0.05, varOfInterest=1)
```

```{r GSEAFileOutput}

# COPD gene sets
tempResults <- decideTests(intrxA[[1]]$fit, adjust.method="fdr", p.value=0.0001)

esetCOPD <- intrxA[[1]]$eset
esetCOPD <- removeFactorLevel(esetCOPD, "FinalCaDXc", "1")
clabels <- cbind(copd_colors[esetCOPD$COPD2_R7], smoking_colors[esetCOPD$SMKc])

# results in 263 genes down with COPD, 329 up with COPD
# test this with visualization heatmap of these genes separately
# define the genes up with COPD
upCOPD <- which(tempResults[, 2] > 0)
upCOPD100 <- match(names(head(sort(intrxA[[1]]$fit$t[, 2], decreasing=TRUE), n=100)), rownames(intrxA[[1]]$fit$t))
# create a heatmap of these genes in the COPD and normal patients
heatmap3(exprs(esetCOPD)[upCOPD, ], col = bluered,
         hclustfun=function(d) hclust(d, method="ward.D"),
         col.clustering = esetCOPD$COPD2_R7, ColSideColors = clabels,
         main = "Genes up with COPD in COPD and normal patients",
         labCol="")
# save the gene set
saveGeneSet(intrxA[[1]]$fit, inds=upCOPD, filename="intrxA_fdr0001_COPD_up_esetClean_allSmokers",
            geneSetName="upCOPD", description="Genes w/ +t for COPD Main Effect")
# save the 100 up gene set
saveGeneSet(intrxA[[1]]$fit, inds=upCOPD100, filename="intrxA_top100_COPD_up_esetClean_allSmokers", geneSetName="upCOPD100", description="Top 100 Genes with +t for COPD Main Effect")

# define the genes down with COPD
dnCOPD <- which(tempResults[, 2] < 0)
dnCOPD100 <- match(names(head(sort(intrxA[[1]]$fit$t[, 2], decreasing=FALSE), n=100)), rownames(intrxA[[1]]$fit$t))
# create a heatmap of these genes in the COPD and normal patients
heatmap3(exprs(esetCOPD)[dnCOPD, ], col = bluered,
         hclustfun=function(d) hclust(d, method="ward.D"),
         col.clustering = esetCOPD$COPD2_R7, ColSideColors = clabels,
         main = "Genes down with COPD in COPD and normal patients",
         labCol="")
# save the gene set
saveGeneSet(intrxA[[1]]$fit, inds=dnCOPD, filename="intrxA_fdr0001_COPD_dn_esetClean_allSmokers",
            geneSetName="dnCOPD", description="Genes w/ -t for COPD Main Effect")
# save the 100 down gene set
saveGeneSet(intrxA[[1]]$fit, inds=dnCOPD100, filename="intrxA_top100_COPD_dn_esetClean_allSmokers", geneSetName="dnCOPD100", description="Top 100 Genes with -t for COPD Main Effect")

# COPD, FEV1, Ratio ranked lists
saveRankedList(intrxA[[1]]$fit, varColInd=2, filename="intrxA_esetClean_allSmokers")

# Cancer gene sets
dnCancer100 <- match(names(head(sort(intrxA[[1]]$fit$t[, 2], decreasing=FALSE), n=100)), rownames(intrxA[[1]]$fit$t))
upCancer100 <- match(names(head(sort(intrxA[[1]]$fit$t[, 2], decreasing=TRUE), n=100)), rownames(intrxA[[1]]$fit$t))
# save the top 100 down and up genes for cancer t-statistic
saveGeneSet(intrxA[[1]]$fit, inds=dnCancer100, filename="intrxA_top100_Cancer_dn_esetClean_allSmokers", geneSetName="dnCancer100", description="Top 100 Genes with -t for Cancer Main Effect")

saveGeneSet(intrxA[[1]]$fit, inds=upCancer100, filename="intrxA_top100_Cancer_up_esetClean_allSmokers", geneSetName="upCancer100", description="Top 100 Genes with +t for Cancer Main Effect")

# Cancer ranked list
saveRankedList(intrxA[[1]]$fit, varColInd=3, filename="intrxA_esetClean_allSmokers")

# Interaction gene sets (ranked lists not as useful)



# Define ATF4 up and down gene sets, and ATF4 ranked list
# Start with ranked list - as Katie did
saveRankedList(atf4Model$fit, varColInd=2, filename="atf4_esetClean_allSmokers")


```







```{r directionality}
eset <- intrxA[[1]]$eset
inds <- match(intrxGenes[[1]], intrxA[[1]]$fit$genes$Symbol)

eset <- eset[inds, ]

# run a t-test for each gene of interest to discover main effect of cancer and main effect of COPD


# also want to determine direction of change between COPD and COPD+Cancer

# setup the variables for contrast building
eset$Cancer <- as.character(eset$FinalCaDXc)
eset$Cancer[eset$FinalCaDXc==1] <- "Cancer"
eset$Cancer[eset$FinalCaDXc==0] <- "noCancer"
eset$COPD <- as.character(eset$COPD2_R7)
eset$COPD[eset$COPD2_R7==1] <- "COPD"
eset$COPD[eset$COPD2_R7==0] <- "noCOPD"
eset$CC <- as.factor(paste(eset$Cancer, eset$COPD, sep="."))

design <- model.matrix(~0 + eset$CC)
colnames(design) <- levels(eset$CC)

fit <- lmFit(eset, design)

# of interest: (COPD+Cancer - COPD) - (Cancer - COPD) = COPD+Cancer - Cancer
# realistically we want a few groups of the genes significant for these terms
# 1. the genes differing between COPD.Cancer and Cancer
# 2. the (1) genes and those also changing between COPD.Cancer and COPD
cont.matrix <- makeContrasts(
  #Difference=(Cancer.COPD-noCancer.COPD)-(Cancer.noCOPD-noCancer.COPD),
  #COPDvCancer=Cancer.noCOPD-noCancer.COPD,
  COPDCavCOPD=Cancer.COPD-noCancer.COPD,
  COPDCavCancer=Cancer.COPD-Cancer.noCOPD,
  COPDCavNormal=Cancer.COPD-noCancer.noCOPD,
  COPDvNormal=noCancer.COPD-noCancer.noCOPD,
  CancervNormal=Cancer.noCOPD-noCancer.noCOPD,
  CancervCOPD=Cancer.noCOPD-noCancer.COPD,
  levels=design)


fit2 <- contrasts.fit(fit, cont.matrix)
fit2 <- eBayes(fit2)

fdr <- 0.05
results <- decideTests(fit2, adjust.method="fdr", p.value=fdr)
# view the results at fdr < 0.05
vennDiagram(results[,1:5])
vennDiagram(results[ ,c(1:3, 6)])
vennDiagram(results[, 1:4])

vennDiagram(results[, c(1,4)])

indUpCOPDCavCOPD <- which(results[, 1] > 0)
indDnCOPDCavCOPD <- which(results[, 1] < 0)

indUpCOPDvNorm <- which(results[, 4] > 0)
indDnCOPDvNorm <- which(results[, 4] < 0)

clabels <- cbind(copdca_colors[eset$indicator], GOLD_colors[eset$GOLD])
heatmap3(exprs(eset)[indUpCOPDCavCOPD, ], col = bluered,
         hclustfun=function(d) hclust(d, method="ward.D"),
         col.clustering = "unsupervised", ColSideColors = clabels,
         main = "RATIO*Cancer\nFDR < 0.05\nFormers Only",
         labCol="")

write.table(fit2$genes$Symbol[indUpCOPDCavCOPD], file="upCOPDCavCOPDintrx.txt", row.names=FALSE, quote=FALSE)
write.table(fit2$genes$Symbol[indDnCOPDCavCOPD], file="dnCOPDCavCOPDintrx.txt", row.names=FALSE, quote=FALSE)
write.table(fit2$genes$Symbol[indUpCOPDvNorm], file="upCOPDvNormintrx.txt", row.names=FALSE, quote=FALSE)
write.table(fit2$genes$Symbol[indDnCOPDvNorm], file="dnCOPDvNormintrx.txt", row.names=FALSE, quote=FALSE)


```
