In this script I am going to attemt to summarize as much of the work I have done as is possible to pull into one place. See headers below for general categories of analyses. 
  
```{r defineFunctions, include=FALSE}
foldChange <- function(eset, groups, genes){
  apply(exprs(eset)[genes, groups==0], 1, mean) - 
    apply(exprs(eset)[genes, groups==1], 1, mean)
}

medianFilter <- function(eset){
  md <- median(exprs(eset))
  passFilter <- logical(featureNumber(eset))
  for(i in 1:featureNumber(eset)){
    passFilter[i] <- sum(exprs(eset)[i, ] > md) > 0
  }
  
  eset <- eset[passFilter, ]
  return(eset)
  
}

saveGeneList <- function(analysis, filename=paste(Sys.Date(), "Temp", analysis$name, ".txt", sep="")){
  
  write.table(analysis$geneSymbols, file=filename, quote=FALSE,row.names=FALSE, col.names=FALSE)

}

saveRankedList <- function(fit, varColInd, filename = "tempRankedList"){
  filename = paste(paste(Sys.Date(), colnames(fit$t)[varColInd], filename, sep="_"), "rnk", sep=".")
  print(filename)
  temp <- data.frame(geneSymbols = fit$genes$Symbol, ts = fit$t[, varColInd])
  write.table(temp, file=filename, row.names=FALSE, quote=FALSE, col.names=TRUE, sep="\t", eol="\n")
  
  
}

saveGeneSet <- function(fit, inds, filename = "tempGeneSet", geneSetName="GeneSet", description=""){
  filename = paste(paste(Sys.Date(), filename, sep="_"), "gmx", sep=".")
  print(filename)
  temp <- data.frame(geneSymbols=c(geneSetName, description, fit$genes$Symbol[inds]))
  write.table(temp, file=filename, row.names=FALSE, quote=FALSE, col.names=FALSE)
  
}

# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  numPlots = length(plots)
  
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
    }
  
  if (numPlots==1) {
    print(plots[[1]])
    } else {
      # Set up the page
      grid.newpage()
      pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
      
      # Make each plot, in the correct location
      for (i in 1:numPlots) {
        # Get the i,j matrix positions of the regions that contain this subplot
        matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
        print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                        layout.pos.col = matchidx$col))
        }
      }
  }

genFileName <- function(filename){
  
  return(paste(Sys.Date(), filename, sep="_"))
}
```

### Setup
```{r setup, eval=TRUE, echo=TRUE, include=FALSE, results='hide'}

setwd("/protected/projects/pulmarray/Allegro/COPD_Cancer/experiments/Expmt_0043_SILCC_Summary/")
source("/protected/projects/pulmarray/Allegro/COPD_Cancer/scripts/AllegroSetup.R")
#source("../2015-05-03_CBM_ATS_2015/plotGSEA.R")
# fix the one patient with wonky data
# eventually this should just be saved in the RDS file
holdEset <- eset
holdEset$FEV1Pc[holdEset$FEV1Pc==89.2] <- 0.892

emt_genes <- read.csv("/protected/projects/pulmarray/Allegro/COPD_Cancer/geneSubsets/emt_gene_symbols_byers_2013.csv", header=FALSE)
temp <- as.factor(unique(as.character(emt_genes$V1)))
emt_genes <- data.frame("EMT_Genes" = temp)

GOLD_colors = c("0" = "gray100", "1" = "gray75", "2" = "gray50", "3" = "gray25", "4" = "black")
greyblack <- colorRampPalette(c("black", "white", "grey"))(256)


# load data, signatures and gene sets
atf4_data <- readRDS("/protected/projects/pulmarray/Allegro/ATF4/ATF4data_2015MAR17_ExpressionSet.rds")

lam_sign <- read.delim("/protected/projects/pulmarray/Allegro/COPD_Cancer/geneSubsets/katie98genesEntrez.txt")
lam_sign[, 3] <- paste(lam_sign[, 2], "_at", sep="")

lamGMT <- read.csv("/protected/projects/pulmarray/Allegro/COPD_Cancer/geneSubsets/100525_lam_98overlapgenes_covars.gmt", sep="\t", as.is=TRUE, header=FALSE)
lamUP <- as.character(lamGMT[1, 3:56])
lamDN <- as.character(lamGMT[2, 3:46])

joshLM127dn <- read.csv("/protected/projects/pulmarray/HoggCOPD/A1ATGrifols/experiments/Expmt_0001_LM_Parenchyma/2015-06-08_Joshdn127.gmx", skip=1, header=TRUE)

joshLM127up <- read.csv("/protected/projects/pulmarray/HoggCOPD/A1ATGrifols/experiments/Expmt_0001_LM_Parenchyma/2015-06-08_Joshup127.gmx", skip=1, header=TRUE)

# from parenchymal REAL data
cleLMup <- read.csv("/protected/projects/pulmarray/HoggCOPD/A1ATGrifols/experiments/Expmt_0003_LM_Parenchyma_CLE/2015-06-24_parenchyma_cle_geneset_cluster2_fdr_0.05.gmx")

cleLMdn <- read.csv("/protected/projects/pulmarray/HoggCOPD/A1ATGrifols/experiments/Expmt_0003_LM_Parenchyma_CLE/2015-06-24_parenchyma_cle_geneset_cluster1_fdr_0.05.gmx")

conLMdn <- read.csv("/protected/projects/pulmarray/HoggCOPD/A1ATGrifols/experiments/Expmt_0005_LM_Parenchyma_Control/2015-06-30_parenchyma_control_geneset_cluster1_fdr_0.15.gmx")

conLMup <- read.csv("/protected/projects/pulmarray/HoggCOPD/A1ATGrifols/experiments/Expmt_0005_LM_Parenchyma_Control/2015-06-30_parenchyma_control_geneset_cluster2_fdr_0.15.gmx")

natMed <- read.csv("/protected/projects/pulmarray/Allegro/COPD_Cancer/geneSubsets/Nature_Medicine_gmx_files/top_100_genes_symbols_quality_adjusted.gmx", sep="\t", as.is=TRUE)
natMedUp <- natMed[2:65, 1]
natMedDn <- natMed[2:37, 2]

tgfB <- read.csv("/protected/projects/pulmarray/Allegro/COPD_Cancer/geneSubsets/msigdb_C2_CGP_genesets/BIOCARTA_TGFB_PATHWAY.gmx", skip=1)
tgfB <- as.character(tgfB$X..TGF.beta.signaling.pathway)

erStress <- as.character(read.csv("/protected/projects/pulmarray/Allegro/COPD_Cancer/geneSubsets/er.entrez.txt", header=FALSE)$V1)

cilioGen <- as.character(read.csv("/protected/projects/pulmarray/Allegro/COPD_Cancer/geneSubsets/cil.entrez.txt", header=FALSE)$V1)

aegisII <- readRDS("/protected/projects/pulmarray/NEJM_AEGIS_2015_CEL/QC/aegis2_150618_ExpressionSet.rds")

hallmarks <- read.csv("/protected/projects/pulmarray/Allegro/COPD_Cancer/geneSubsets/hallmarksbroadinstituteGENE_SYMBOL.gmx.txt", sep="\t")
hallmarks <- hallmarks[2:197, 1:50]
hMarkList = list()
for(i in 1:dim(hallmarks)[2])
  {
  temp <- as.character(hallmarks[, i])
  temp <- temp[temp != ""]
  hMarkList[[names(hallmarks)[i]]] <- temp
  
  }

curatedSets <- read.csv("/protected/projects/pulmarray/Allegro/COPD_Cancer/geneSubsets/curatedSets.gseaftp.broadinstitute.org___pub_gsea_annotations_GENE_SYMBOL.chip.gmx", sep="\t")
curatedSets <- curatedSets[2:883, 1:1094]
curList = list()
for(i in 1:dim(curatedSets)[2])
  {
  temp <- as.character(curatedSets[, i])
  temp <- temp[temp != ""]
  curList[[names(curatedSets)[i]]] <- temp
  
  }



#atf4_targets <- read.delim("ATF4_Targets_Enrichr_TRANSFACJASPAR_270Genes.txt", sep=",", as.is=TRUE, header=FALSE)
#atf4_targets <- as.character(atf4_targets)

#a4LEup <- read.delim("ATF4_targets_cluster1_270Genes_LeadingEdge_Up.csv", header=FALSE)
#a4LEup <- as.character(a4LEup$V1)

#a4LEdn <- read.delim("ATF4_targets_cluster2_270Genes_LeadingEdge_Down.csv", header=FALSE)
#a4LEdn <- as.character(a4LEdn$V1)
library(znorm)
library(diptest)
library(GSVA)
library(annotate)
library(org.Hs.eg.db)
library(corrplot)
library(ggplot2)
library(beeswarm)
library(ASSIGN)

### Analysis Variables
SAVE=FALSE
```

### Data Cleaning
```{r cleanup}

# Remaining question - should we keep or remove the COPD GOLD Status 1 patients? i.e. mild disease
# What about patients using or their charts indicating they have used corticosteroids?
esetClean <- holdEset
esetClean <- cleanNAForAnalysis(esetClean, "COPD2_R7")
esetClean <- cleanNAForAnalysis(esetClean, "RATIOc")
esetClean <- cleanNAForAnalysis(esetClean, "PYc")
esetClean <- cleanNAForAnalysis(esetClean, "RIN")
esetClean <- removeFactorLevel(esetClean, "COPD2_R7", "DK")
esetClean <- removeFactorLevel(esetClean, "FinalCaDXc", "DK")
esetClean <- removeFactorLevel(esetClean, "COPD2_R7", "DK")
esetClean <- removeFactorLevel(esetClean, "GENDERc", "DK")

esetClean <- calcIndicator(esetClean, "FinalCaDXc", "COPD2_R7")
esetClean$smkindic <- as.numeric(as.character(esetClean$indicator))
esetClean$smkindic[esetClean$SMKc==2] <- esetClean$smkindic[esetClean$SMKc==2] + 4
esetClean$smkindic <- as.factor(esetClean$smkindic)

# Define the GOLD Stage appropriate for all patients
esetClean$GOLD <- factor(x=rep(0, sampleNumber(esetClean)), levels=c("0","1","2","3","4"))
# GOLD Stage 1 Ratio < 0.7, FEV1 >= 8
esetClean$GOLD[esetClean$RATIOc < 0.7 & esetClean$FEV1Pc >= 0.8] <- 1
# GOLD Stage 2 Ratio < 0.7, 50 <= FEV1 < 80
esetClean$GOLD[esetClean$RATIOc < 0.7 & esetClean$FEV1Pc < 0.8] <- 2
# GOLD Stage 3 Ratio < 0.7, 30 <= FEV1 <= 50
esetClean$GOLD[esetClean$RATIOc < 0.7 & esetClean$FEV1Pc < 0.5] <- 3
# GOLD Stage 4 Ratio < 0.7, FEV1 < 30%
esetClean$GOLD[esetClean$RATIOc < 0.7 & esetClean$FEV1Pc < 0.3] <- 4

esetClean <- removeBioReps(esetClean)
esetCleanFormers <- removeFactorLevel(esetClean, "SMKc", "1")
esetCleanCurrents <- removeFactorLevel(esetClean, "SMKc", "2")
# Generate a super clean dataset devoid of all patients with other pulmonary diseases
esetSuperClean <- esetClean
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroPNAc", "1")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroTBc", "1")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroSarcoidc", "1")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroIPFc", "1")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroIPFc", "DK")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroAtelectasisc", "1")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroAtelectasisc", "DK")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroAsthmac", "DK")
esetSuperClean <- removeFactorLevel(esetSuperClean, "AllegroAsthmac", "1")

esetSuperCleanICS <- removeFactorLevel(esetSuperClean, "AllegroCorticosteroidsc", "1")
esetSuperCleanICS <- removeFactorLevel(esetSuperCleanICS, "AllegroCorticosteroidsc", "DK")

# clean up ATF4 data
varLabels(atf4_data) <- "SampleID"
atf4_data$SampleID[grep("ATF4", atf4_data$SampleID)] <- "ATF4"
atf4_data$SampleID[grep("Ctrl", atf4_data$SampleID)] <- "Control"
atf4_data$SampleID <- as.factor(atf4_data$SampleID)

atf4_colors <- c("ATF4" = "red", "Control" = "black")


```

### ATF4 Models
```{r ATF4models}
# generate ATF4 model(s)
varLabels(atf4_data)[1] <- "SampleID"
atf4Model <- lmFitWrapper(atf4_data, c("SampleID"),
                          name="ATF4 Perturbation Data", adjust.method="none",
                          p.value=0.05, varOfInterest=1)

clabels <- cbind(atf4_colors[as.character(atf4_data$SampleID)])
heatmap3(exprs(atf4_data)[atf4Model$inds, ], col = bluered,
         hclustfun=function(d) hclust(d, method="ward.D"),
         col.clustering = atf4_data$SampleID, ColSideColors = clabels,
         main = "ATF4 Genes",
         labCol="")

hmapClusts <- heatmap3(exprs(atf4_data)[atf4Model$inds,], col = bluered,
                       keep.dendro=TRUE,
                       hclustfun=function(d) hclust(d, method="ward.D"),
                       col.clustering = atf4_data$SampleID, ColSideColors=clabels,
                       main="ATF4 Genes", labCol="")

clusters <- cutree(as.hclust(hmapClusts$Rowv), k=2)
atf4Cluster1_dn <- atf4Model$geneSymbols[clusters==1]
atf4Cluster2_up <- atf4Model$geneSymbols[clusters==2]

atf4dn <- names(clusters)[clusters==1]
atf4up <- names(clusters)[clusters==2]
atf4 <- names(clusters)

rlabels <- cbind(smoking_colors[clusters])
heatmap3(exprs(atf4_data)[atf4Model$inds,], col = bluered,
         keep.dendro=TRUE,
         hclustfun=function(d) hclust(d, method="ward.D"),
         col.clustering = atf4_data$SampleID, ColSideColors=clabels,
         main="ATF4 Genes", labCol="", RowSideColors=rlabels)



```

## Interaction Models
### Among All Patients  
```{r intrxAlla}
target <- medianFilter(esetClean)
tName = "intrxAlla"
tempModel <- lmFitWrapper(target, c("COPD2_R7", "FinalCaDXc", "SMKc", "AGEcalc", "RIN", "GENDERc", "COPD2_R7*FinalCaDXc"), 7, "fdr", 0.15, "Interaction Model 1 Among All Patients")

clabels <- cbind(copdca_colors[target$indicator], smoking_colors[as.character(target$SMKc)])
tempHMap <- heatmap3(exprs(target)[tempModel$inds, ], col=bluered,
         hclustfun=function(d) hclust(d, method="ward.D"),
         col.clustering=target$indicator, ColSideColors=clabels,
         main=tempModel$hMapName, labCol="", keep.dendro=TRUE)

if(SAVE){
  tempClusters <- cutree(as.hclust(tempHMap$Rowv), k=2)

  # save entire gene list
  write.table(tempModel$geneSymbols, file=genFileName(paste(tName, ".txt", sep="")), quote=FALSE, row.names=FALSE, col.names=FALSE)
  # save cluster 1 gene list
  write.table(tempModel$geneSymbols[tempClusters==1], file=genFileName(paste(tName, "c1.txt", sep="")))
  
  # save cluster 2 gene list
  write.table(tempModel$geneSymbols[tempClusters==2], file=genFileName(paste(tName, "c2.txt", sep="")))

}

intrxAllaResults <- list(model=tempModel, heatmap=tempHMap)
```

### Among All Patients + ICS
```{r intrxAllb}
target <- medianFilter(removeFactorLevel(esetClean, "AllegroCorticosteroidsc", "DK"))
tName = "intrxAllb"
tempModel <- lmFitWrapper(target, c("COPD2_R7", "FinalCaDXc", "SMKc", "AGEcalc", "RIN", "GENDERc", "AllegroCorticosteroidsc", "COPD2_R7*FinalCaDXc"), 8, "fdr", 0.2, "Interaction Model 2 +ICS Among All Patients")

clabels <- cbind(copdca_colors[target$indicator], smoking_colors[as.character(target$SMKc)])
tempHMap <- heatmap3(exprs(target)[tempModel$inds, ], col=bluered,
         hclustfun=function(d) hclust(d, method="ward.D"),
         col.clustering=target$indicator, ColSideColors=clabels,
         main=tempModel$hMapName, labCol="", keep.dendro=TRUE)


if(SAVE){
  tempClusters <- cutree(as.hclust(tempHMap$Rowv), k=2)

  # save entire gene list
  write.table(tempModel$geneSymbols, file=genFileName(paste(tName, ".txt", sep="")), quote=FALSE, row.names=FALSE, col.names=FALSE)
  # save cluster 1 gene list
  write.table(tempModel$geneSymbols[tempClusters==1], file=genFileName(paste(tName, "c1.txt", sep="")))
  
  # save cluster 2 gene list
  write.table(tempModel$geneSymbols[tempClusters==2], file=genFileName(paste(tName, "c2.txt", sep="")))

}

intrxAllbResults <- list(model=tempModel, heatmap=tempHMap)
```


### Among Former Smokers  
```{r intrxFormera}
target <- medianFilter(esetCleanFormers)
tName = "intrxFormera"
tempModel <- lmFitWrapper(target, c("COPD2_R7", "FinalCaDXc", "AGEcalc", "RIN", "GENDERc", "COPD2_R7*FinalCaDXc"), 6, "fdr", 0.3, "Interaction Model 1 Among Former Smokers")

clabels <- cbind(copdca_colors[target$indicator], smoking_colors[as.character(target$SMKc)])
tempHMap <- heatmap3(exprs(target)[tempModel$inds, ], col=bluered,
         hclustfun=function(d) hclust(d, method="ward.D"),
         col.clustering=target$indicator, ColSideColors=clabels,
         main=tempModel$hMapName, labCol="", keep.dendro=TRUE)

if(SAVE){
  tempClusters <- cutree(as.hclust(tempHMap$Rowv), k=2)

  # save entire gene list
  write.table(tempModel$geneSymbols, file=genFileName(paste(tName, ".txt", sep="")), quote=FALSE, row.names=FALSE, col.names=FALSE)
  # save cluster 1 gene list
  write.table(tempModel$geneSymbols[tempClusters==1], file=genFileName(paste(tName, "c1.txt", sep="")))
  
  # save cluster 2 gene list
  write.table(tempModel$geneSymbols[tempClusters==2], file=genFileName(paste(tName, "c2.txt", sep="")))

}

intrxFormeraResults <- list(model=tempModel, heatmap=tempHMap)
```

### Among Former Smokers + ICS
```{r intrxFormerb}
target <- medianFilter(removeFactorLevel(esetCleanFormers, "AllegroCorticosteroidsc", "DK"))
tName = "intrxFormerb"
tempModel <- lmFitWrapper(target, c("COPD2_R7", "FinalCaDXc", "AGEcalc", "RIN", "GENDERc", "AllegroCorticosteroidsc", "COPD2_R7*FinalCaDXc"), 7, "none", 0.01, "Interaction Model 2 +ICS Among Former Smokers")

clabels <- cbind(copdca_colors[target$indicator], smoking_colors[as.character(target$SMKc)])
tempHMap <- heatmap3(exprs(target)[tempModel$inds, ], col=bluered,
         hclustfun=function(d) hclust(d, method="ward.D"),
         col.clustering=target$indicator, ColSideColors=clabels,
         main=tempModel$hMapName, labCol="", keep.dendro=TRUE)


if(SAVE){
  tempClusters <- cutree(as.hclust(tempHMap$Rowv), k=2)

  # save entire gene list
  write.table(tempModel$geneSymbols, file=genFileName(paste(tName, ".txt", sep="")), quote=FALSE, row.names=FALSE, col.names=FALSE)
  # save cluster 1 gene list
  write.table(tempModel$geneSymbols[tempClusters==1], file=genFileName(paste(tName, "c1.txt", sep="")))
  
  # save cluster 2 gene list
  write.table(tempModel$geneSymbols[tempClusters==2], file=genFileName(paste(tName, "c2.txt", sep="")))

}

intrxFormerbResults <- list(model=tempModel, heatmap=tempHMap)
```

### Among Current Smokers   
```{r intrxCurrenta}
target <- medianFilter(esetCleanCurrents)
tName = "intrxCurrenta"
tempModel <- lmFitWrapper(target, c("COPD2_R7", "FinalCaDXc", "AGEcalc", "RIN", "GENDERc", "COPD2_R7*FinalCaDXc"), 6, "none", 0.05, "Interaction Model 1 Among Current Smokers")

clabels <- cbind(copdca_colors[target$indicator], smoking_colors[as.character(target$SMKc)])
tempHMap <- heatmap3(exprs(target)[tempModel$inds, ], col=bluered,
         hclustfun=function(d) hclust(d, method="ward.D"),
         col.clustering=target$indicator, ColSideColors=clabels,
         main=tempModel$hMapName, labCol="", keep.dendro=TRUE)

if(SAVE){
  tempClusters <- cutree(as.hclust(tempHMap$Rowv), k=2)

  # save entire gene list
  write.table(tempModel$geneSymbols, file=genFileName(paste(tName, ".txt", sep="")), quote=FALSE, row.names=FALSE, col.names=FALSE)
  # save cluster 1 gene list
  write.table(tempModel$geneSymbols[tempClusters==1], file=genFileName(paste(tName, "c1.txt", sep="")))
  
  # save cluster 2 gene list
  write.table(tempModel$geneSymbols[tempClusters==2], file=genFileName(paste(tName, "c2.txt", sep="")))

}

intrxCurrentaResults <- list(model=tempModel, heatmap=tempHMap)
```

### Among Current Smokers + ICS
```{r intrxCurrentb}
target <- medianFilter(removeFactorLevel(esetCleanCurrents, "AllegroCorticosteroidsc", "DK"))
tName = "intrxCurrentb"
tempModel <- lmFitWrapper(target, c("COPD2_R7", "FinalCaDXc", "AGEcalc", "RIN", "GENDERc", "AllegroCorticosteroidsc", "COPD2_R7*FinalCaDXc"), 7, "none", 0.01, "Interaction Model 2 +ICS Among Current Smokers")

clabels <- cbind(copdca_colors[target$indicator], smoking_colors[as.character(target$SMKc)])
tempHMap <- heatmap3(exprs(target)[tempModel$inds, ], col=bluered,
         hclustfun=function(d) hclust(d, method="ward.D"),
         col.clustering=target$indicator, ColSideColors=clabels,
         main=tempModel$hMapName, labCol="", keep.dendro=TRUE)


if(SAVE){
  tempClusters <- cutree(as.hclust(tempHMap$Rowv), k=2)

  # save entire gene list
  write.table(tempModel$geneSymbols, file=genFileName(paste(tName, ".txt", sep="")), quote=FALSE, row.names=FALSE, col.names=FALSE)
  # save cluster 1 gene list
  write.table(tempModel$geneSymbols[tempClusters==1], file=genFileName(paste(tName, "c1.txt", sep="")))
  
  # save cluster 2 gene list
  write.table(tempModel$geneSymbols[tempClusters==2], file=genFileName(paste(tName, "c2.txt", sep="")))

}

intrxCurrentbResults <- list(model=tempModel, heatmap=tempHMap)
```


## 3 v 1 Group Analysis - this is statistically terrible    
### Among All Patients  
### Among Former Smokers  
### Among Current Smokers  


## 3 Model Approach  
### Among All Patients  
```{r tripModAll}

# Katie uses age, sex, smoking, and pack years
# She also attempts to account for corticosteroids by removing them, repeating
# the analysis and checking for enrichment in the overlapping genes

target <- medianFilter(esetClean)
adjust="none"
fdrVals <- c(0.005, 0.01, 0.05)
#fdrVals <- c(0.05, 0.1, 0.2)
intrxA <- list()
intrxB <- list()
intrxC <- list()
intrxGenes <- list()
intrxInds <- list()

for(i in 1:length(fdrVals)){
  eset <- target
	# clean the eset for COPD data and other variables
	intrxA[[i]] <- lmFitWrapper(eset, c("COPD2_R7", "FinalCaDXc", "AGEcalc",
                                     "GENDERc", "PYc", "RIN",
                                     "SMKc", "COPD2_R7*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method=adjust, p.value=fdrVals[i],
                             varOfInterest=8)
                             
	intrxB[[i]] <- lmFitWrapper(eset, c("FEV1Pc", "FinalCaDXc", "AGEcalc",
                                     "GENDERc", "PYc", "RIN",
                                     "SMKc", "FEV1Pc*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method=adjust, p.value=fdrVals[i],
                             varOfInterest=8)

	intrxC[[i]] <- lmFitWrapper(eset, c("RATIOc", "FinalCaDXc", "AGEcalc",
                                     "GENDERc", "PYc", "RIN",
                                     "SMKc", "RATIOc*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method=adjust, p.value=fdrVals[i],
                             varOfInterest=8)

  intrxGenes[[i]] <- intersect(intrxA[[i]]$geneSymbols, intersect(intrxB[[i]]$geneSymbols, intrxC[[i]]$geneSymbols))
  intrxInds[[i]] <- intersect(intrxA[[i]]$inds, intersect(intrxB[[i]]$inds, intrxC[[i]]$inds))

	length(intrxA[[i]]$geneSymbols)
	length(intrxB[[i]]$geneSymbols)
	length(intrxC[[i]]$geneSymbols)
	length(intrxGenes[[i]])
	
	#filename <- paste("OverlappingGenes", as.character(length(overlappingGenes)),
						#"fdr", as.character(fdrVals[i]), ".txt", sep="")
	#write.table(overlappingGenes, file=filename, quote=FALSE,
            #row.names=FALSE, col.names=FALSE)

}

tripleModAll <- list(target=target, adjust=adjust, fdrVals=fdrVals, 
                      intrxA=intrxA, intrxB=intrxB, intrxC=intrxC,
                      intrxGenes=intrxGenes, intrxInds=intrxInds)

```

### Among Former Smokers  
```{r tripModFormers}

# Katie uses age, sex, smoking, and pack years
# She also attempts to account for corticosteroids by removing them, repeating
# the analysis and checking for enrichment in the overlapping genes

target <- medianFilter(esetCleanFormers)
adjust="none"
fdrVals <- c(0.005, 0.01, 0.05)
intrxA <- list()
intrxB <- list()
intrxC <- list()
intrxGenes <- list()
intrxInds <- list()

for(i in 1:length(fdrVals)){
  eset <- target
  # clean the eset for COPD data and other variables
	intrxA[[i]] <- lmFitWrapper(eset, c("COPD2_R7", "FinalCaDXc", "AGEcalc",
                                     "GENDERc", "PYc", "RIN",
                                     "COPD2_R7*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method=adjust, p.value=fdrVals[i],
                             varOfInterest=7)
                             
	intrxB[[i]] <- lmFitWrapper(eset, c("FEV1Pc", "FinalCaDXc", "AGEcalc",
                                     "GENDERc", "PYc", "RIN",
                                     "FEV1Pc*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method=adjust, p.value=fdrVals[i],
                             varOfInterest=7)

	intrxC[[i]] <- lmFitWrapper(eset, c("RATIOc", "FinalCaDXc", "AGEcalc",
                                     "GENDERc", "PYc", "RIN",
                                     "RATIOc*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method=adjust, p.value=fdrVals[i],
                             varOfInterest=7)


	intrxGenes[[i]] <- intersect(intrxA[[i]]$geneSymbols, intersect(intrxB[[i]]$geneSymbols, intrxC[[i]]$geneSymbols))
    intrxInds[[i]] <- intersect(intrxA[[i]]$inds, intersect(intrxB[[i]]$inds, intrxC[[i]]$inds))


	length(intrxA[[i]]$geneSymbols)
	length(intrxB[[i]]$geneSymbols)
	length(intrxC[[i]]$geneSymbols)
	length(intrxGenes[[i]])
	
	#filename <- paste("OverlappingGenes", as.character(length(overlappingGenes)),
						#"fdr", as.character(fdrVals[i]), ".txt", sep="")
	#write.table(overlappingGenes, file=filename, quote=FALSE,
            #row.names=FALSE, col.names=FALSE)

}

tripleModFormers <- list(target=target, adjust=adjust, fdrVals=fdrVals, 
                      intrxA=intrxA, intrxB=intrxB, intrxC=intrxC,
                      intrxGenes=intrxGenes, intrxInds=intrxInds)
```

### Among Current Smokers  
```{r tripModCurrents}

# Katie uses age, sex, smoking, and pack years
# She also attempts to account for corticosteroids by removing them, repeating
# the analysis and checking for enrichment in the overlapping genes

target <- medianFilter(esetCleanCurrents)
adjust="none"
fdrVals <- c(0.005, 0.01, 0.05)
intrxA <- list()
intrxB <- list()
intrxC <- list()
intrxGenes <- list()
intrxInds <- list()

for(i in 1:length(fdrVals)){
  eset <- target
  # clean the eset for COPD data and other variables
  intrxA[[i]] <- lmFitWrapper(eset, c("COPD2_R7", "FinalCaDXc", "AGEcalc",
                                     "GENDERc", "PYc", "RIN",
                                     "COPD2_R7*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method=adjust, p.value=fdrVals[i],
                             varOfInterest=7)
                             
	intrxB[[i]] <- lmFitWrapper(eset, c("FEV1Pc", "FinalCaDXc", "AGEcalc",
                                     "GENDERc", "PYc", "RIN",
                                     "FEV1Pc*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method=adjust, p.value=fdrVals[i],
                             varOfInterest=7)

	intrxC[[i]] <- lmFitWrapper(eset, c("RATIOc", "FinalCaDXc", "AGEcalc",
                                     "GENDERc", "PYc", "RIN",
                                     "RATIOc*FinalCaDXc"),
                             name="COPD Signal",
                             adjust.method=adjust, p.value=fdrVals[i],
                             varOfInterest=7)


	intrxGenes[[i]] <- intersect(intrxA[[i]]$geneSymbols, intersect(intrxB[[i]]$geneSymbols, intrxC[[i]]$geneSymbols))
    intrxInds[[i]] <- intersect(intrxA[[i]]$inds, intersect(intrxB[[i]]$inds, intrxC[[i]]$inds))


	length(intrxA[[i]]$geneSymbols)
	length(intrxB[[i]]$geneSymbols)
	length(intrxC[[i]]$geneSymbols)
	length(intrxGenes[[i]])
	
	#filename <- paste("OverlappingGenes", as.character(length(overlappingGenes)),
						#"fdr", as.character(fdrVals[i]), ".txt", sep="")
	#write.table(overlappingGenes, file=filename, quote=FALSE,
            #row.names=FALSE, col.names=FALSE)

}

tripleModCurrents <- list(target=target, adjust=adjust, fdrVals=fdrVals, 
                      intrxA=intrxA, intrxB=intrxB, intrxC=intrxC,
                      intrxGenes=intrxGenes, intrxInds=intrxInds)
```

## GSVA Correlation Analyses
### GSVA Results Generation
```{r GSVAresults}
# generate GSVA for lmCLE signatures, atf4, and emt
eset <- esetClean

genesets <- list(lmCLEup=as.character(cleLMup$GeneSet),
                 lmCLEdn=as.character(cleLMdn$GeneSet),
                 atf4dn=atf4Cluster1_dn,
                 atf4up=atf4Cluster2_up,
                 emt=as.character(emt_genes$EMT_Genes),
                 lamUP=lamUP,
                 lamDN=lamDN,
                 lm127dn=as.character(joshLM127dn$Genes.down.with.LM),
                 lm127up=as.character(joshLM127up$Genes.up.with.LM),
                 natMedDn=natMedDn,
                 natMedUp=natMedUp,
                 tgfBeta=tgfB,
                 lmCONup=as.character(conLMup$GeneSet),
                 lmCONdn=as.character(conLMdn$GeneSet),
                 erStress=as.character(getSYMBOL(erStress, data='org.Hs.eg')),
                 cilia=as.character(getSYMBOL(cilioGen, data='org.Hs.eg')))



temp <- getSYMBOL(return_entrez(featureNames(eset)), data='org.Hs.eg')
eset2 <- eset[!is.na(temp), ]
featureNames(eset2) <- getSYMBOL(return_entrez(featureNames(eset2)), data='org.Hs.eg')

gsvaResults <- gsva(eset2, genesets)
gsvaHMark <- gsva(eset2, hMarkList)
gsvaCurated <- gsva(eset2, curList)
#gsvaResults <- gsva(eset2, genesets, no.bootstraps=10, method="zscore")

lm_up=1; lm_dn=2; a_up=4; a_dn=3; emt=5;
lam_UP=6; lam_DN=7; l127d=8; l127u=9; canDn=10; canUp=11; tbeta=12
lm_con_up=13; lm_con_dn=14; erSt=15; cil=16


noCopd.noCancer = gsvaResults$es.obs$indicator==1
noCopd.Cancer = gsvaResults$es.obs$indicator==2
copd.noCancer = gsvaResults$es.obs$indicator==3
copd.Cancer = gsvaResults$es.obs$indicator==4

noCancer = gsvaResults$es.obs$FinalCaDXc==0
cancer = gsvaResults$es.obs$FinalCaDXc==1

copd = gsvaResults$es.obs$COPD2_R7==1
noCopd = gsvaResults$es.obs$COPD2_R7==0

former=gsvaResults$es.obs$SMKc==2
current=gsvaResults$es.obs$SMKc==1


```

### GSVA Correlation Plots Across All Patients
```{r gsvaCorPlot1}
target <- gsvaResults$es.obs
numGeneSets <- featureNumber(target)
numComps <- ((numGeneSets*numGeneSets - numGeneSets) / 2)
gsvaCors <- gsvaCorPs <- gsvaCorPsBonf <- matrix(ncol=numGeneSets, nrow=numGeneSets)
rownames(gsvaCors) <- colnames(gsvaCors) <- rownames(gsvaCorPs) <- colnames(gsvaCorPs) <- featureNames(target)
 
for(i in 1:numGeneSets){
  for(j in 1:numGeneSets){
    gsvaCors[i,j] <- cor(t(exprs(target[i, ])), t(exprs(target[j,])))
    gsvaCorPs[i,j] <- cor.test(t(exprs(target[i, ])), t(exprs(target[j,])))$p.value
    gsvaCorPsBonf[i,j] <- gsvaCorPs[i,j]*numComps
  } 
}

#corrplot(gsvaCors, method="circle", cl.ratio=0.2, tl.cex=0.8, order='hclust')
#corrplot(gsvaCors, tl.cex=0.8, order='hclust', tl.pos='l', tl.srt=45)

#use the p-values
corrplot.mixed(gsvaCors, tl.cex=0.8, p.mat=gsvaCorPsBonf, insig="blank", tl.pos='l', tl.srt=30, sig.level= 0.0000005, main="All Patients, p < 0.0000005")

```

### GSVA Correlation Plots Across Former Smokers
```{r gsvaCorPlot2}
target <- gsvaResults$es.obs[, former]
numGeneSets <- featureNumber(target)
numComps <- ((numGeneSets*numGeneSets - numGeneSets) / 2)
gsvaCors <- gsvaCorPs <- gsvaCorPsBonf <- matrix(ncol=numGeneSets, nrow=numGeneSets)
rownames(gsvaCors) <- colnames(gsvaCors) <- rownames(gsvaCorPs) <- colnames(gsvaCorPs) <- featureNames(target)
 
for(i in 1:numGeneSets){
  for(j in 1:numGeneSets){
    gsvaCors[i,j] <- cor(t(exprs(target[i, ])), t(exprs(target[j,])))
    gsvaCorPs[i,j] <- cor.test(t(exprs(target[i, ])), t(exprs(target[j,])))$p.value
    gsvaCorPsBonf[i,j] <- gsvaCorPs[i,j]*numComps
  } 
}

#corrplot(gsvaCors, method="circle", cl.ratio=0.2, tl.cex=0.8, order='hclust')
#corrplot(gsvaCors, tl.cex=0.8, order='hclust', tl.pos='l', tl.srt=45)

#use the p-values
corrplot.mixed(gsvaCors, tl.cex=0.8, p.mat=gsvaCorPsBonf, insig="blank", tl.pos='l', tl.srt=30, sig.level= 0.0000005, main="Former Smokers Patients, p < 0.0000005")

```

### GSVA Correlation Plots Across Current Smokers
```{r gsvaCorPlot3}
target <- gsvaResults$es.obs[, current]
numGeneSets <- featureNumber(target)
numComps <- ((numGeneSets*numGeneSets - numGeneSets) / 2)
gsvaCors <- gsvaCorPs <- gsvaCorPsBonf <- matrix(ncol=numGeneSets, nrow=numGeneSets)
rownames(gsvaCors) <- colnames(gsvaCors) <- rownames(gsvaCorPs) <- colnames(gsvaCorPs) <- featureNames(target)
 
for(i in 1:numGeneSets){
  for(j in 1:numGeneSets){
    gsvaCors[i,j] <- cor(t(exprs(target[i, ])), t(exprs(target[j,])))
    gsvaCorPs[i,j] <- cor.test(t(exprs(target[i, ])), t(exprs(target[j,])))$p.value
    gsvaCorPsBonf[i,j] <- gsvaCorPs[i,j]*numComps
  } 
}

#corrplot(gsvaCors, method="circle", cl.ratio=0.2, tl.cex=0.8, order='hclust')
#corrplot(gsvaCors, tl.cex=0.8, order='hclust', tl.pos='l', tl.srt=45)

#use the p-values
corrplot.mixed(gsvaCors, tl.cex=0.8, p.mat=gsvaCorPsBonf, insig="blank", tl.pos='l', tl.srt=30, sig.level= 0.0000005, main="Former Smokers Patients, p < 0.0000005")

```

### GSVA Score Comparisons for Lab Signatures
```{r gsvaComparisonsLab}
gsvaLM <- lmFitWrapper(gsvaResults$es.obs, c("COPD2_R7", "FinalCaDXc", "COPD2_R7*FinalCaDXc"), 1, "fdr", 0.05)
which(gsvaLM$results[,2] < 0)
which(gsvaLM$results[,2] > 0)
which(gsvaLM$results[,3] < 0)
which(gsvaLM$results[,3] > 0)

#tt <- lmFitWrapper(gsvaResults$es.obs, c("COPD2_R7"), 1, "none", 0.05)
#which(tt$results[,2] < 0)
#which(tt$results[,2] > 0)

tt2 <- lmFitWrapper(gsvaResults$es.obs[, noCancer], c("COPD2_R7"), 1, "none", 0.2)
which(tt2$results[,2] < 0)
which(tt2$results[,2] > 0)

tt3 <- lmFitWrapper(gsvaResults$es.obs[tt2$inds, copd], c("FinalCaDXc"), 1, "none", 0.1)
which(tt3$results[,2] < 0)

which(tt3$results[,2] > 0)

tt3a <- lmFitWrapper(gsvaResults$es.obs[, copd], c("FinalCaDXc"), 1, "none", 0.05)

```

### GSVA Correlation Plots for Lab Signatures noCancer
```{r gsvaCorPlotLabnoCancer}
target <- gsvaResults$es.obs[, noCancer]
numGeneSets <- featureNumber(target)
numComps <- ((numGeneSets*numGeneSets - numGeneSets) / 2)
gsvaCors <- gsvaCorPs <- gsvaCorPsBonf <- matrix(ncol=numGeneSets, nrow=numGeneSets)
rownames(gsvaCors) <- colnames(gsvaCors) <- rownames(gsvaCorPs) <- colnames(gsvaCorPs) <- featureNames(target)
 
for(i in 1:numGeneSets){
  for(j in 1:numGeneSets){
    gsvaCors[i,j] <- cor(t(exprs(target[i, ])), t(exprs(target[j,])))
    gsvaCorPs[i,j] <- cor.test(t(exprs(target[i, ])), t(exprs(target[j,])))$p.value
    gsvaCorPsBonf[i,j] <- gsvaCorPs[i,j]*numComps
  } 
}

#corrplot(gsvaCors, method="circle", cl.ratio=0.2, tl.cex=0.8, order='hclust')
#corrplot(gsvaCors, tl.cex=0.8, order='hclust', tl.pos='l', tl.srt=45)

#use the p-values
corrplot.mixed(gsvaCors, tl.cex=0.8, p.mat=gsvaCorPsBonf, insig="blank", tl.pos='l', tl.srt=30, sig.level= 0.0000005, main="noCancer, p < 0.0000005")

plot(exprs(target)[1,], exprs(target)[3, ], col=copdca_colors[as.character(target$indicator)], main="LM_CLE Up v ATF4 Down", xlab="low LM\t\t\t\t\t\t\t\t\t\t\t\thigh LM\nLM CLE Up", ylab="high ATF4\t\t\t\t\t\t\t\t\t\t\t\tlowATF4\n ATF4 Down")

plot(exprs(target)[2,], exprs(target)[4, ], col=copdca_colors[as.character(target$indicator)], main="LM_CLE Down v ATF4 Up", xlab="high LM\t\t\t\t\t\t\t\t\t\t\t\tlow LM\nLM CLE Down", ylab="low ATF4\t\t\t\t\t\t\t\t\t\t\t\thigh ATF4\n ATF4 Up")

plot(exprs(target)[6,], exprs(target)[5, ], col=copdca_colors[as.character(target$indicator)], main="Lam Up v EMT", xlab="no COPD\t\t\t\t\t\t\t\t\t\t\t\tCOPD\nLam Up", ylab="low EMT Signature\t\t\t\t\t\t\t\t\t\t\t\thigh EMT Signature\n EMT")

plot(exprs(target)[2,], exprs(target)[13, ], col=copdca_colors[as.character(target$indicator)], main="LM CLE Down v LM Control Up", xlab="LM CLE Down", ylab="LM Control Up")

```

### GSVA Correlation Plots for Lab Signatures COPD
```{r gsvaCorPlotLabCOPD}
target <- gsvaResults$es.obs[, copd]
numGeneSets <- featureNumber(target)
numComps <- ((numGeneSets*numGeneSets - numGeneSets) / 2)
gsvaCors <- gsvaCorPs <- gsvaCorPsBonf <- matrix(ncol=numGeneSets, nrow=numGeneSets)
rownames(gsvaCors) <- colnames(gsvaCors) <- rownames(gsvaCorPs) <- colnames(gsvaCorPs) <- featureNames(target)
 
for(i in 1:numGeneSets){
  for(j in 1:numGeneSets){
    gsvaCors[i,j] <- cor(t(exprs(target[i, ])), t(exprs(target[j,])))
    gsvaCorPs[i,j] <- cor.test(t(exprs(target[i, ])), t(exprs(target[j,])))$p.value
    gsvaCorPsBonf[i,j] <- gsvaCorPs[i,j]*numComps
  } 
}

#corrplot(gsvaCors, method="circle", cl.ratio=0.2, tl.cex=0.8, order='hclust')
#corrplot(gsvaCors, tl.cex=0.8, order='hclust', tl.pos='l', tl.srt=45)

#use the p-values
corrplot.mixed(gsvaCors, tl.cex=0.8, p.mat=gsvaCorPsBonf, insig="blank", tl.pos='l', tl.srt=30, sig.level= 0.0000005, main="COPD, p < 0.0000005")

plot(exprs(target)[1,], exprs(target)[3, ], col=copdca_colors[as.character(target$indicator)], main="LM_CLE Up v ATF4 Down", xlab="low LM\t\t\t\t\t\t\t\t\t\t\t\thigh LM\nLM CLE Up", ylab="high ATF4\t\t\t\t\t\t\t\t\t\t\t\tlowATF4\n ATF4 Down")

plot(exprs(target)[2,], exprs(target)[4, ], col=copdca_colors[as.character(target$indicator)], main="LM_CLE Down v ATF4 Up", xlab="high LM\t\t\t\t\t\t\t\t\t\t\t\tlow LM\nLM CLE Down", ylab="low ATF4\t\t\t\t\t\t\t\t\t\t\t\thigh ATF4\n ATF4 Up")

plot(exprs(target)[6,], exprs(target)[5, ], col=copdca_colors[as.character(target$indicator)], main="Lam Up v EMT", xlab="no COPD\t\t\t\t\t\t\t\t\t\t\t\tCOPD\nLam Up", ylab="low EMT Signature\t\t\t\t\t\t\t\t\t\t\t\thigh EMT Signature\n EMT")

plot(exprs(target)[15,], exprs(target)[2, ], col=copdca_colors[as.character(target$indicator)], main="ER Stress v LM CLE Down", xlab="ER Stress", ylab="LM CLE Down")

```

### GSVA Correlation Plots Across All Patients for Hallmark Genesets
```{r gsvaHallmarks}
target <- gsvaHMark$es.obs
numGeneSets <- featureNumber(target)
numComps <- ((numGeneSets*numGeneSets - numGeneSets) / 2)
gsvaCors <- gsvaCorPs <- gsvaCorPsBonf <- matrix(ncol=numGeneSets, nrow=numGeneSets)
rownames(gsvaCors) <- colnames(gsvaCors) <- rownames(gsvaCorPs) <- colnames(gsvaCorPs) <- gsub("HALLMARK_", "", featureNames(target))
 
for(i in 1:numGeneSets){
  for(j in 1:numGeneSets){
    gsvaCors[i,j] <- cor(t(exprs(target[i, ])), t(exprs(target[j,])))
    gsvaCorPs[i,j] <- cor.test(t(exprs(target[i, ])), t(exprs(target[j,])))$p.value
    gsvaCorPsBonf[i,j] <- gsvaCorPs[i,j]*numComps
  } 
}

#corrplot(gsvaCors, method="circle", cl.ratio=0.2, tl.cex=0.8, order='hclust')
#corrplot(gsvaCors, tl.cex=0.8, order='hclust', tl.pos='l', tl.srt=45)

#use the p-values
corrplot.mixed(gsvaCors, tl.cex=0.8, p.mat=gsvaCorPsBonf, insig="blank", tl.pos='l', tl.srt=30, sig.level= 0.0000005, main="All Patients, p < 0.0000005")

# Compare the hallmark scores using limma
gHmkTest <- lmFitWrapper(gsvaHMark$es.obs[, noCancer], c("COPD2_R7"), 1, "none", 0.05)
which(gHmkTest$results[, 2] > 0)
which(gHmkTest$results[, 2] < 0)

gHmkTest2 <- lmFitWrapper(gsvaHMark$es.obs[gHmkTest$inds, copd], c("FinalCaDXc"), 1, "none", 0.05)
which(gHmkTest2$results[, 2] > 0)
which(gHmkTest2$results[, 2] < 0)

gHmkTest3 <- lmFitWrapper(gsvaHMark$es.obs[, ], c("COPD2_R7", "FinalCaDXc", "COPD2_R7*FinalCaDXc"), 3, "none", 0.05)
which(gHmkTest3$results[, 4] > 0)
which(gHmkTest3$results[, 4] < 0)



```

### GSVA Correlation Plots Across All Patients for Curated Genesets
```{r gsvaCurated}
target <- gsvaCurated$es.obs

# Compare the hallmark scores using limma
gCurTest <- lmFitWrapper(target[, noCancer], c("COPD2_R7"), 1, "none", 0.05)
upCOPD = which(gCurTest$results[, 2] > 0)
dnCOPD = which(gCurTest$results[, 2] < 0)

gCurTestup <- lmFitWrapper(target[upCOPD, copd], c("FinalCaDXc"), 1, "none", 0.05)
gCurTestdn <- lmFitWrapper(target[dnCOPD, copd], c("FinalCaDXc"), 1, "none", 0.05)

gCurTestup$inds
gCurTestdn$inds


```

### Analagous Model Filter for Genes
```{r modelfilterGenes}
eset2 <- esetClean
#temp <- getSYMBOL(return_entrez(featureNames(eset)), data='org.Hs.eg')
#eset2 <- eset[!is.na(temp), ]
#featureNames(eset2) <- getSYMBOL(return_entrez(featureNames(eset2)), data='org.Hs.eg')

modFilter <- lmFitWrapper(eset2[, noCancer], c("COPD2_R7"), 1, "none", 0.05)
modCC <- lmFitWrapper(eset2[modFilter$inds, copd], c("FinalCaDXc"), 1, "none", 0.05)

# Use fisher exact to determine if these genes overlap significantly with any of the
# gene sets similarly identified
fisherResults <- numeric(length=length(curList))
for(i in 1:length(curList)){
  fisherResults[i] <- fisher.test(as.factor(modFilter$fit$genes$Symbol %in% modCC$geneSymbols), as.factor(modFilter$fit$genes$Symbol %in% curList[[i]]))$"p.value"
  
}


sigLists <- names(curList)[which(fisherResults < 0.12)]

modListsSigupCancer <- names(which(gCurTestdn$results[, 2] > 0))
modListsSigdnCancer <- names(which(gCurTestup$results[, 2] < 0))

intersect(modListsSigupCancer, sigLists)
intersect(modListsSigdnCancer, sigLists)


```


## Two Cancer Analysis  
### Genes changing with cancer in all Smokers without COPD
```{r twoCancerAllSmknoCOPD}
target <- removeFactorLevel(removeFactorLevel(esetClean, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "1")
twoCancerAllSmknoCOPD <- lmFitWrapper(target, c("FinalCaDXc", "AllegroCorticosteroidsc", "GENDERc", "RATIOc", "SMKc", "RIN", "AGEcalc","GENDERc*FinalCaDXc"),1, "none", 0.01)

# generate the gene ranked list for genes changing with cancer among non-COPD-ers

if(SAVE){
  rankedList <- data.frame(genes=twoCancerAllSmknoCOPD$fit$genes$Symbol, tstat=twoCancerAllSmknoCOPD $fit$t[,2])
  # write out the ranked list to file
  filename = "twoCancerAllSmknoCOPD"
  filename = paste(paste(Sys.Date(), filename, sep="_"), "rnk", sep=".")
  write.table(rankedList, file=filename, row.names=FALSE, quote=FALSE,
              col.names=TRUE, sep="\t", eol="\n")

}

clabels <- cbind(cancer_colors[as.character(target$FinalCaDXc)], smoking_colors[as.character(target$SMKc)])
h0 = heatmap3(exprs(target)[twoCancerAllSmknoCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              keep.dendro=TRUE, ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among all smokers\np < 0.01")

rClusts1 = cutree(as.hclust(h0$Rowv), k=2)
heatmap3(exprs(target)[twoCancerAllSmknoCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among all smokers\np < 0.01",
         RowSideColors=rClusts1)
```

### Genes changing with cancer in Former Smokers without COPD
```{r twoCancerForSmknoCOPD}
target <- removeFactorLevel(removeFactorLevel(esetCleanFormers, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "1")
twoCancerForSmknoCOPD <- lmFitWrapper(target, c("FinalCaDXc", "AllegroCorticosteroidsc", "GENDERc", "RATIOc", "RIN", "AGEcalc", "GENDERc*FinalCaDXc", "AllegroCorticosteroidsc*FinalCaDXc"),1, "none", 0.01)

# generate the gene ranked list for genes changing with cancer among non-COPD-ers

if(SAVE){
  rankedList <- data.frame(genes=cccc$fit$genes$Symbol, tstat=cccc$fit$t[,2])
  # write out the ranked list to file
  filename = "nonCOPDCancerRankedList"
  filename = paste(paste(Sys.Date(), filename, sep="_"), "rnk", sep=".")
  write.table(rankedList, file=filename, row.names=FALSE, quote=FALSE,
              col.names=TRUE, sep="\t", eol="\n")

}

clabels <- cbind(cancer_colors[as.character(target$FinalCaDXc)], smoking_colors[as.character(target$SMKc)])
h0 = heatmap3(exprs(target)[twoCancerForSmknoCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              keep.dendro=TRUE, ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among former smokers\np < 0.01")

rClusts1 = cutree(as.hclust(h0$Rowv), k=2)
heatmap3(exprs(target)[twoCancerForSmknoCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among former smokers\np < 0.01",
         RowSideColors=rClusts1)

# Visualize the former smoker cancer genes in current smokers
target2 <- removeFactorLevel(removeFactorLevel(esetCleanCurrents, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "1")
clabels <- cbind(cancer_colors[as.character(target2$FinalCaDXc)], smoking_colors[as.character(target2$SMKc)])

heatmap3(exprs(target2)[twoCancerForSmknoCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among former smokers\nviz in Current\np < 0.01",
         RowSideColors=rClusts1)

# Visualize the former smoker cancer genes in former smokers with COPD +/- cancer
target2 <- removeFactorLevel(removeFactorLevel(esetCleanFormers, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "0")

clabels <- cbind(cancer_colors[as.character(target2$FinalCaDXc)], smoking_colors[as.character(target2$SMKc)])
heatmap3(exprs(target2)[twoCancerForSmknoCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among former smokers\nviz in Formers with COPD\np < 0.01",
         RowSideColors=rClusts1)


```

### Genes changing with cancer in Current Smokers without COPD
```{r twoCancerCurSmknoCOPD}
target <- removeFactorLevel(removeFactorLevel(esetCleanCurrents, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "1")
twoCancerCurSmknoCOPD <- lmFitWrapper(target, c("FinalCaDXc", "AllegroCorticosteroidsc", "GENDERc", "RATIOc", "RIN", "AGEcalc", "GENDERc*FinalCaDXc"),1, "none", 0.01)

# generate the gene ranked list for genes changing with cancer among non-COPD-ers

if(SAVE){
  rankedList <- data.frame(genes=cccc$fit$genes$Symbol, tstat=cccc$fit$t[,2])
  # write out the ranked list to file
  filename = "nonCOPDCancerRankedList"
  filename = paste(paste(Sys.Date(), filename, sep="_"), "rnk", sep=".")
  write.table(rankedList, file=filename, row.names=FALSE, quote=FALSE,
              col.names=TRUE, sep="\t", eol="\n")

}

clabels <- cbind(cancer_colors[as.character(target$FinalCaDXc)], smoking_colors[as.character(target$SMKc)])
h0 = heatmap3(exprs(target)[twoCancerCurSmknoCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              keep.dendro=TRUE, ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among current smokers\np < 0.01")

rClusts1 = cutree(as.hclust(h0$Rowv), k=2)
heatmap3(exprs(target)[twoCancerCurSmknoCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among current smokers\np < 0.01",
         RowSideColors=rClusts1)

# Visualize the former smoker cancer genes in current smokers
target2 <- removeFactorLevel(removeFactorLevel(esetCleanFormers, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "1")
clabels <- cbind(cancer_colors[as.character(target2$FinalCaDXc)], smoking_colors[as.character(target2$SMKc)])

heatmap3(exprs(target2)[twoCancerCurSmknoCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among current smokers\nviz in Former\np < 0.01",
         RowSideColors=rClusts1)

```

### Genes changing with cancer in all Smokers with COPD
```{r twoCancerAllSmkCOPD}
target <- removeFactorLevel(removeFactorLevel(esetClean, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "0")
twoCancerAllSmkCOPD <- lmFitWrapper(target, c("FinalCaDXc", "AllegroCorticosteroidsc", "GENDERc", "RATIOc", "SMKc", "RIN", "AGEcalc", "GENDERc*FinalCaDXc"),1, "none", 0.01)

# generate the gene ranked list for genes changing with cancer among non-COPD-ers

if(SAVE){
  rankedList <- data.frame(genes=cccc$fit$genes$Symbol, tstat=cccc$fit$t[,2])
  # write out the ranked list to file
  filename = "nonCOPDCancerRankedList"
  filename = paste(paste(Sys.Date(), filename, sep="_"), "rnk", sep=".")
  write.table(rankedList, file=filename, row.names=FALSE, quote=FALSE,
              col.names=TRUE, sep="\t", eol="\n")

}

clabels <- cbind(cancer_colors[as.character(target$FinalCaDXc)], smoking_colors[as.character(target$SMKc)])
h0 = heatmap3(exprs(target)[twoCancerAllSmkCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              keep.dendro=TRUE, ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in COPD among all smokers\np < 0.01")

rClusts1 = cutree(as.hclust(h0$Rowv), k=2)
heatmap3(exprs(target)[twoCancerAllSmkCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in COPD among all smokers\np < 0.01",
         RowSideColors=rClusts1)
```

### Genes changing with cancer in Former Smokers with COPD
```{r twoCancerForSmkCOPD}
target <- removeFactorLevel(removeFactorLevel(esetCleanFormers, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "0")
twoCancerForSmkCOPD <- lmFitWrapper(target, c("FinalCaDXc", "AllegroCorticosteroidsc", "GENDERc", "RATIOc", "RIN", "GENDERc*FinalCaDXc"),1, "none", 0.01)

# generate the gene ranked list for genes changing with cancer among non-COPD-ers

if(SAVE){
  rankedList <- data.frame(genes=cccc$fit$genes$Symbol, tstat=cccc$fit$t[,2])
  # write out the ranked list to file
  filename = "nonCOPDCancerRankedList"
  filename = paste(paste(Sys.Date(), filename, sep="_"), "rnk", sep=".")
  write.table(rankedList, file=filename, row.names=FALSE, quote=FALSE,
              col.names=TRUE, sep="\t", eol="\n")

}

clabels <- cbind(cancer_colors[as.character(target$FinalCaDXc)], smoking_colors[as.character(target$GENDERc)])
h0 = heatmap3(exprs(target)[twoCancerForSmkCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              keep.dendro=TRUE, ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in COPD among former smokers\np < 0.001")

rClusts1 = cutree(as.hclust(h0$Rowv), k=2)
heatmap3(exprs(target)[twoCancerForSmkCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in COPD among former smokers\np < 0.01",
         RowSideColors=rClusts1)

# Visualize the former smoker cancer genes in current smokers
target2 <- removeFactorLevel(removeFactorLevel(esetCleanCurrents, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "0")
clabels <- cbind(cancer_colors[as.character(target2$FinalCaDXc)], smoking_colors[as.character(target2$SMKc)])

heatmap3(exprs(target2)[twoCancerForSmkCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among former smokers\nviz in Current\np < 0.01",
         RowSideColors=rClusts1)

# Visualize the former smoker cancer genes in former smokers without COPD
target2 <- removeFactorLevel(removeFactorLevel(esetCleanFormers, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "1")
clabels <- cbind(cancer_colors[as.character(target2$FinalCaDXc)], smoking_colors[as.character(target2$SMKc)])

heatmap3(exprs(target2)[twoCancerForSmkCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among former smokers\nviz in Current\np < 0.01",
         RowSideColors=rClusts1)


```

### Genes changing with cancer in Current Smokers with COPD
```{r twoCancerCurSmkCOPD}
target <- removeFactorLevel(removeFactorLevel(esetCleanCurrents, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "0")
twoCancerCurSmkCOPD <- lmFitWrapper(target, c("FinalCaDXc", "AllegroCorticosteroidsc", "GENDERc", "RATIOc", "RIN", "GENDERc*FinalCaDXc"),1, "none", 0.01)

# generate the gene ranked list for genes changing with cancer among non-COPD-ers

if(SAVE){
  rankedList <- data.frame(genes=cccc$fit$genes$Symbol, tstat=cccc$fit$t[,2])
  # write out the ranked list to file
  filename = "nonCOPDCancerRankedList"
  filename = paste(paste(Sys.Date(), filename, sep="_"), "rnk", sep=".")
  write.table(rankedList, file=filename, row.names=FALSE, quote=FALSE,
              col.names=TRUE, sep="\t", eol="\n")

}

clabels <- cbind(cancer_colors[as.character(target$FinalCaDXc)], smoking_colors[as.character(target$GENDERc)])
h0 = heatmap3(exprs(target)[twoCancerCurSmkCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              keep.dendro=TRUE, ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in COPD among current smokers\np < 0.001")

rClusts1 = cutree(as.hclust(h0$Rowv), k=2)
heatmap3(exprs(target)[twoCancerCurSmkCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in COPD among current smokers\np < 0.01",
         RowSideColors=rClusts1)

# Visualize the former smoker cancer genes in current smokers
target2 <- removeFactorLevel(removeFactorLevel(esetCleanFormers, "AllegroCorticosteroidsc", "DK"), "COPD2_R7", "0")
clabels <- cbind(cancer_colors[as.character(target2$FinalCaDXc)], smoking_colors[as.character(target2$SMKc)])

heatmap3(exprs(target2)[twoCancerCurSmkCOPD$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main="Genes changing with cancer in non-COPD among current smokers\nviz in Former\np < 0.01",
         RowSideColors=rClusts1)

```

## Contrast Analyses Group-by-Group (Chan)  
I believe these are similar to the models run above in the subgroups of samples  

## ER Stress and Ciliogenesis Gene sets (Duclos) 
```{r ERStressCiliaComprs}
# these are in entrez gene symbol form
# work first on the ER genes changing with cancer in former smokers without COPD
target <- removeFactorLevel(removeFactorLevel(esetClean, "AllegroCorticosteroidsc", "DK"),
                            "COPD2_R7", "1")
genes <- paste(erStress, "_at", sep="")
genes <- genes[which(!is.na(match(genes, featureNames(target))))]
inds <- match(genes, featureNames(target))
target <- target[inds, ]

erModel1 <- lmFitWrapper(target, c("FinalCaDXc", "GENDERc", "AGEcalc", "RIN", "AllegroCorticosteroidsc"), 1, "fdr", 0.25, "ER Stress Genes changing with cancer among former smokers without COPD")

clabels <- cbind(cancer_colors[as.character(target$FinalCaDXc)], smoking_colors[as.character(target$GENDERc)])
h0 = heatmap3(exprs(target)[erModel1$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              keep.dendro=TRUE, ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main=erModel1$hMapName)

# work next on the ER genes changing with cancer in former smokers with COPD
target <- removeFactorLevel(removeFactorLevel(esetClean, "AllegroCorticosteroidsc", "DK"),
                            "COPD2_R7", "0")
genes <- paste(erStress, "_at", sep="")
genes <- genes[which(!is.na(match(genes, featureNames(target))))]
inds <- match(genes, featureNames(target))
target <- target[inds, ]

erModel2 <- lmFitWrapper(target, c("FinalCaDXc", "GENDERc", "AGEcalc", "RIN", "AllegroCorticosteroidsc"), 1, "none", 0.05, "ER Stress Genes changing with cancer among former smokers with COPD")

clabels <- cbind(cancer_colors[as.character(target$FinalCaDXc)], smoking_colors[as.character(target$GENDERc)])
h0 = heatmap3(exprs(target)[erModel2$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              keep.dendro=TRUE, ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main=erModel2$hMapName)




```

## EMT Genes Differential Expression (Byers et al.)  
```{r EMTComprs}
# these are in gene symbol form
genes <- as.character(emt_genes$EMT_Genes)
allGenes <- getSYMBOL(return_entrez(featureNames(eset2)), data='org.Hs.eg')


```

## AEGIS II Initial Analysis
```{r aegisII}
target <- aegisII
aIIM1 <- lmFitWrapper(target, c("Clinical.Diagnosis", "COPD.ass.pulm", "Age", "Smk", "Gender","Clinical.Diagnosis*COPD.ass.pulm"), 6, "fdr", 0.05, "aegis II interaction")

clabels <- cbind(cancer_colors[as.character(as.numeric(as.factor(target$Clinical.Diagnosis))-1)]
, copd_colors[as.character(target$COPD.ass.pulm)])
h0 = heatmap3(exprs(target)[aIIM1$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              keep.dendro=TRUE, ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main=aIIM1$hMapName)

target <- aegisII
target$Inhaled.Meds.RFMEDS.for.RFCAT.INHALE <- as.factor(target$Inhaled.Meds.RFMEDS.for.RFCAT.INHALE)
target <- removeFactorLevel(target, "Inhaled.Meds.RFMEDS.for.RFCAT.INHALE", "MV")
target <- removeFactorLevel(target, "Inhaled.Meds.RFMEDS.for.RFCAT.INHALE", "DK")
target <- removeFactorLevel(target, "Inhaled.Meds.RFMEDS.for.RFCAT.INHALE", "")
target$Smk <- as.factor(target$Smk)
target <- removeFactorLevel(target, "Smk", "2")
target$COPD.ass.pulm <- as.factor(target$COPD.ass.pulm)
target <- removeFactorLevel(target, "COPD.ass.pulm", "0")
target$Clinical.Diagnosis <- as.factor(target$Clinical.Diagnosis)

inds <- match(names(twoCancerForSmkCOPD$inds), featureNames(target))
inds <- inds[!is.na(inds)]
target <- target[inds, ]
  
aIIM2 <- lmFitWrapper(target, c("Clinical.Diagnosis", "Age", "Gender", "Gender*Clinical.Diagnosis"), 1, "none", 0.05, "aegis II cancer in formers with copd")
clabels <- cbind(cancer_colors[as.character(as.numeric(as.factor(target$Clinical.Diagnosis))-1)]
, copd_colors[as.character(target$COPD.ass.pulm)])
h0 = heatmap3(exprs(target)[aIIM2$inds, ], col=bluered,
              hclustfun=function(d) hclust(d, method="ward.D"),
              keep.dendro=TRUE, ColSideColors=clabels,
              labCol="", col.clustering="semisupervised",
              main=aIIM2$hMapName)


```

```{r gsvaAEGISII}
eset <- aegisII

temp <- getSYMBOL(return_entrez(featureNames(eset)), data='org.Hs.eg')
eset2 <- eset[!is.na(temp), ]
featureNames(eset2) <- getSYMBOL(return_entrez(featureNames(eset2)), data='org.Hs.eg')

gsvaResultsA2 <- gsva(eset2, genesets)
gsvaHMarkA2 <- gsva(eset2, hMarkList)
gsvaCuratedA2 <- gsva(eset2, curList)
#gsvaResults <- gsva(eset2, genesets, no.bootstraps=10, method="zscore")

# COPD.ass.pulm, Clinical.Diagnosis
gsvaResultsA2$es.obs$Clinical.Diagnosis <- as.factor(gsvaResultsA2$es.obs$Clinical.Diagnosis)
gsvaResultsA2$es.obs$COPD.ass.pulm <- as.factor(gsvaResultsA2$es.obs$COPD.ass.pulm)

gsvaLMA2noCancer <- lmFitWrapper(gsvaResultsA2$es.obs[, gsvaResultsA2$es.obs$Clinical.Diagnosis=="Declared Negative"], c("COPD.ass.pulm"), 1, "none", 0.05)
which(gsvaLMA2noCancer$results[, 2] > 0)
which(gsvaLMA2noCancer$results[, 2] < 0)

gsvaLMA2COPD <- lmFitWrapper(gsvaResultsA2$es.obs[, gsvaResultsA2$es.obs$COPD.ass.pulm=="1"], c("Clinical.Diagnosis"), 1, "none", 0.1)
which(gsvaLMA2COPD$results[, 2] > 0)
which(gsvaLMA2COPD$results[, 2] < 0)



```

